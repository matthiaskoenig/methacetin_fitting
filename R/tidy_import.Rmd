---
title: "Import SBML"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(results = 'hold')
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE)

library(dMod)
library(stringr) # Um bequem mit strings zu arbeiten
library(tidyverse) # Viele Funktionen, u.a. für data.frames und ggplot2 für schöne plots
library(magrittr) # der Pipe-operator %>%: z.B: x = a; y=f(x); z=g(y); wird zu z= a %>% f %>% g
library(conveniencefunctions)
library(libSBML)
library(rlang)
set_names <- magrittr::set_names
```

## Read the model
This is basically copied from a libSBML-example
```{r}

filename <- "/home/dl140/Promotion/Projects/methacetin_fitting/model/limax_pkpd_37.xml" # Attention: tilde expansion doesn't work
d <-  readSBML(filename)

m <- SBMLDocument_getModel(d)
# errors   = SBMLDocument_getNumErrors(d);
# SBMLDocument_printErrors(d);


level   = SBase_getLevel  (d);
version = SBase_getVersion(d);

cat("File: ",filename," (Level ",level,", version ",version,")\n");
cat("  model id: ", ifelse(Model_isSetId(m), Model_getId(m) ,"(empty)"),"\n");




cat( "       compartments: ", Model_getNumCompartments       (m) ,"\n" );
cat( "   compartmentTypes: ", Model_getNumCompartmentTypes   (m) ,"\n" );
cat( "        constraints: ", Model_getNumConstraints        (m) ,"\n" );
cat( "             events: ", Model_getNumEvents             (m) ,"\n" );
cat( "functionDefinitions: ", Model_getNumFunctionDefinitions(m) ,"\n" );
cat( " initialAssignments: ", Model_getNumInitialAssignments (m) ,"\n" );
cat( "         parameters: ", Model_getNumParameters         (m) ,"\n" );
cat( "          reactions: ", Model_getNumReactions          (m) ,"\n" );
cat( "              rules: ", Model_getNumRules              (m) ,"\n" );
cat( "            species: ", Model_getNumSpecies            (m) ,"\n" );
cat( "        specieTypes: ", Model_getNumSpeciesTypes       (m) ,"\n" );
cat( "    unitDefinitions: ", Model_getNumUnitDefinitions    (m) ,"\n" );
cat( "\n" )

```

Get all data types in the SBML document
```{r}
sbml_objects <- ls(envir = as.environment("package:libSBML")) %>% str_subset("Model_getList(.*)") %>% .[!str_detect(.,"SWIG")] %>% str_replace_all("Model_getListOf", "")

sbml_object_lists <- lapply(sbml_objects, function(i) eval(call(paste0("Model_getListOf", i), m)))
sbml_object_numbers <- lapply(sbml_objects, function(i) eval(call(paste0("Model_getNum", i), m)))

# data.frame(sbml_objects = sbml_objects, sbml_object_lists = sbml_object_lists, sbml_object_numbers = sbml_object_numbers)


sbml_objects <- sbml_objects[sbml_object_numbers > 0]
sbml_object_lists <- sbml_object_lists[sbml_object_numbers > 0] %>% set_names(sbml_objects)
sbml_object_numbers <- sbml_object_numbers[sbml_object_numbers >0]%>% set_names(sbml_objects)
```


##Compartments

Was ich haben will:

object %>% 
find all get functions that I can use and their required arguments %>% 
use the functions. This gives me a list of objects %>% 
lapply  find all get functions that I can use and their required arguments %>% 
        use the functions. This gives me a list of objects %>%
        lapply  find all get functions that I can use and their required arguments %>% 
                use the functions. This gives me a list of objects %>% 
                lapply  find all get functions that I can use and their required arguments %>% 
                        use the functions. This gives me a list of objects %>% 

```{r}
function_names
function_arguments
```

```{r}
apply_get_functions <- function(myobject) {
  myclass <- class(myobject)
  if(!str_detect(myclass, "^_p_")) {return(myobject)}

  cat("___________________________________\n")
  
  class_get <- myclass %>% str_replace_all("^_p_", "") %>% paste0("_get")
  function_names <- ls(envir = as.environment("package:libSBML")) %>% str_subset(paste0("^", class_get, "(.*)")) 
  
  # function_names <- function_names %>% .[!str_detect(.,"ListOf")]
  
  function_arguments <- lapply(function_names, . %>% get %>% attributes %>% .[["inputTypes"]]) %>% set_names(function_names)
  
  swig0 <- function_names %>% str_subset(.,"SWIG_0")
  function_arguments[swig0 %>% str_replace("__SWIG.*", "")] <- function_arguments[swig0]
  
  is_swig <- function_names %>% str_detect("SWIG")
  function_names <- function_names[!is_swig]
  function_arguments <- function_arguments[!is_swig]
  
  has_character_arguments <- sapply(function_arguments, function(myargs) "character" %in% myargs)
  cat("kicked out (char): ", function_names[has_character_arguments], "\n")
  function_names <- function_names[!has_character_arguments]
  function_arguments <- function_arguments[!has_character_arguments]
  
  
  # populate n
  # n <- eval(call(function_names %>% str_subset("getNum"), myobject))
  n <- sbml_object_numbers[["Compartments"]]
  
  
  has_integer_arguments <- sapply(function_arguments, function(myargs) "integer" %in% myargs)
  
  out_0 <- lapply(function_names[!has_integer_arguments], function(fun) eval(call(fun, self = myobject))) %>% set_names(function_names[!has_integer_arguments])

  if (!is.null(n)) {
    out_1 <- lapply(0:(n-1), function(i) {
      lapply(function_names[has_integer_arguments], function(fun) eval(call(fun, self = myobject, n = i))) %>% set_names(function_names[has_integer_arguments])
    })
  }

  
  cat("kicked out (int): ", function_names[has_integer_arguments], "\n")
  function_names <- function_names[!has_integer_arguments]
  function_arguments <- function_arguments[!has_integer_arguments]
  
  has_numeric_arguments <- sapply(function_arguments, function(myargs) "numeric" %in% myargs)
  cat("kicked out (num): ", function_names[has_numeric_arguments], "\n")
  function_names <- function_names[!has_numeric_arguments]
  function_arguments <- function_arguments[!has_numeric_arguments]
  
  
  
  
  
  # print(function_arguments)
  cat("_________\n")
  lapply(function_names, function(fun) eval(call(fun, myobject))) %>% set_names(function_names) %T>% print() %>% {.}
}

str(out_1)
```

```{r}
myobject <-

  sbml_object_lists[["Compartments"]] %>%
  ListOfCompartments_get(0) %>% 
  
  # ListOfCompartmentGlyphs(0) %>%
  #   FunctionDefinition_getBody() %>% 

  # m %>%
  # Model_getCompartment(0) %>%
  
  # Compartment_getDerivedUnitDefinition() %>%
  # UnitDefinition_getUnit(0) %>%
  {.}
apply_get_functions(myobject) %>% 
  # lapply(., function(myobj) apply_get_functions(myobj)) %>%
  str2
  # {.}


```

```{r}
myobject <-

  # sbml_object_lists[["Compartments"]] %>%
  # ListOfCompartments_get(0) %>%
  
  m %>%
  Model_getFunctionDefinition(0) %>% 
  # FunctionDefinition_getMath() %>% 

  # Compartment_getDerivedUnitDefinition() %>%
  # UnitDefinition_getUnit(0) %>%
  {.}
apply_get_functions(myobject) %>% 
  lapply(., function(myobj) apply_get_functions(myobj)) %>%
  str2
  # {.}

  
```


```{r}
myobject <-
  sbml_object_lists[["Compartments"]] %>% 
  ListOfCompartments_get(0) %>% 
  Compartment_getDerivedUnitDefinition() %>% 
  # UnitDefinition_getUnit(0) %>% 
  {.}
  


myclass <- class(myobject)

  class_get <- myclass %>% str_replace_all("^_p_", "") %>% paste0("_get")
  function_names <- ls(envir = as.environment("package:libSBML")) %>% str_subset(paste0("^", class_get, "(.*)")) 
  
  function_arguments <- lapply(function_names, . %>% get %>% attributes %>% .[["inputTypes"]]) %>% set_names(function_names)
  
  swig0 <- function_names %>% str_subset(.,"SWIG_0")
  function_arguments[swig0 %>% str_replace("__SWIG.*", "")] <- function_arguments[swig0]
  
  is_swig <- function_names %>% str_detect("SWIG")
  function_names <- function_names[!is_swig]
  function_arguments <- function_arguments[!is_swig]
  
  has_character_arguments <- sapply(function_arguments, function(myargs) "character" %in% myargs)
  function_names <- function_names[!has_character_arguments]
  function_arguments <- function_arguments[!has_character_arguments]
  
  
  
  
  
  # return(function_names)
# }

ListOfCompartments_get__SWIG_0
```

```{r}
i <- 0
lapply(seq(0, sbml_object_numbers[["Compartments"]]-1), function(i) {
 # wup <-
   sbml_object_lists[["Compartments"]] %>% 
    # Extract elements from the ListOf...-----
    {
   myobject <- .
   myclass <- class(myobject)
   # print(p_get_fn(myclass)) #
   eval(call(p_get_fn(myclass)[1], myobject, i))
 } %>% 
    # For this element, run all possible p_class_get* functions
    {
   myobject <- .
   myclass <- class(myobject) %>% print
   # print(p_get_fn(myclass)) #
   lapply(p_get_fn(myclass), function(fun) eval(call(fun, myobject))) %>%  set_names(p_get_fn(myclass) %>% str_replace(".*_get", ""))
 } %>% 
    # For each element, if it is still of class _p_*, run again all possible get_functions
    {
   myobj <- .
   lapply(myobj, function(myobject) {
     
     myclass <- class(myobject) %>% print
     print(p_get_fn(myclass)) 
     if(length(p_get_fn(myclass))>0) {
       
       
       lapply(p_get_fn(myclass) , function(fun) eval(call(fun, myobject)) %>% print) %>%  
         set_names(p_get_fn(myclass) %>% str_replace(".*_get", ""))
     
       } else {
       return(myobject)
     }
   })
 } %>% print
})
ListOfCompartments_get



```


##FunctionDefinitions


##InitialAssignments


##Parameters


##Reactions


##Rules


##Species


##UnitDefinitions




























