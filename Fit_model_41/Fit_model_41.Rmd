---
title: "Fitting model 41"
output: 
  html_document:
    toc: TRUE
---


Load all important libraries
```{r setup, message=FALSE, warning=FALSE, eval=TRUE, echo=FALSE}
knitr::opts_chunk$set(eval = TRUE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(fig.width = 15)
library(dMod)
# library(stringr) # Um bequem mit strings zu arbeiten
# library(tidyverse) # Viele Funktionen, u.a. für data.frames und ggplot2 für schöne plots
# library(magrittr) # der Pipe-operator %>%: z.B: x =" a; y="f(x); z="g(y); wird zu z=" a %>% f %>% g
library(conveniencefunctions)

```


# Read model
```{r read_model, dependson="setup"}
source("../model/limax_pkpd_v41.R")

pars_raw <- c(x0, p) 
pars_in_dxdtdmod <- c(getSymbols(dxdt_dmod), names(dxdt_dmod))
```


# Data - read and preprocess
Read data, insert the default values for the parameters supplied in the data sheet. 

* Taheri rausschmeißen zum Fitten: Wird weiter unten getan

```{r, message=FALSE}
# Read data
data_full <-
  read_tsv("../data/limax_pkpd_v41_data.csv") %>%
  select(-model) %>% 
  rename(name = observer) %>% 
  rename(n = subjects) %>% 
  unique() #noch matthias sagen, dass lalazar2008 doppelte einträge hat

# For those studies where some data points have no sigma, infer it from the other sigmas of the same study
fitErrorModel_factors <- c("study", "group", "name", "BW", "PODOSE_apap", "IVDOSE_apap", 
"PODOSE_co2c13", "IVDOSE_co2c13", "Ri_co2c13", "ti_co2c13", "PODOSE_metc13", 
"IVDOSE_metc13", "ti_metc13")
some_na <-
  data_full %>% 
  group_by(study, group, name) %>% 
  mutate(nna = n(), sna = sum(is.na(sigma))) %>% 
  filter(sna>0 & sna != nna) %>% 
  select(-sna, -nna) %>% 
  as.data.frame() %>% 
  fitErrorModel(factors = fitErrorModel_factors, plotting = F, blather = F) 

none_or_all_na <- data_full %>% 
  group_by(study, group, name) %>% 
  mutate(nna = n(), sna = sum(is.na(sigma))) %>% 
  filter(sna==0 | sna == nna) %>% 
  select(-sna, -nna) %>% 
  as.data.frame()

data_full <- rbind(some_na, none_or_all_na) %>% 
  select(-n)

```

# Set up the model

```{r setup model independently of the individual setups}
# Parameters to fit by Matthias
free_pars_apap <- c("Ka_apap", "APAPD_HLM_CL", "APAPD_Km_apap")
free_pars_bic <- c("Ka_co2c13", "KLU_EXCO2", "CO2FIX_HLM_CL", "KBO_FIXCO2", "KBO_RELCO2", "KBO_MAXCO2")
free_pars_met <- c("Ka_metc13", "CYP1A2MET_CL", "CYP1A2MET_Km_met")

free_pars <- c(free_pars_apap, free_pars_bic, free_pars_met)

# Observables
observables_apap <- y_dmod[c("Mve_apap")] %>% set_names(c("Mve_apap"))

recovery_bic <- paste(y_dmod["Exhalation_co2c13"], "/ 60 * Mr_co2c13 / Ri_co2c13 * 100")
P_CO2F <- paste0(y_dmod["P_CO2Fc13"], "-", str_replace(y_dmod["P_CO2Fc13"], "Alu_co2c13", "0")) # Alu_co2c13 is the only dynamic variable which goes into the equation and it's initial value is fixed to zero.

observables_bic <- c(cum_rec_co2c13 = recovery_bic, y_dmod[c("DOB")], P_CO2F = P_CO2F)

recovery_met <- paste(y_dmod["Exhalation_co2c13"], "/ init_PODOSE_metc13 * Mr_metc13 * 100" )
cum_met <- paste( "Abreath_co2c13/ init_PODOSE_metc13 * Mr_metc13 * 100")
observables_met <- c(recovery_met, cum_met) %>% set_names(c("mom_rec_metc13", "cum_rec_metc13"))

# Error models
errors_bic_sigma_NA <- paste0("sqrt(s0_", names(observables_bic), "^2 + srel_", names(observables_bic), "^2 * ", names(observables_bic), "^2 )") %>% set_names(names(observables_bic))
errors_bic_sigma_NA["cum_rec_co2c13"] <- 1 #hierfür gibts eh keine daten und ich weiß nicht, ob ich es einfach weglassen kann

errors_met_sigma_NA <- paste0("sqrt(s0_", names(observables_met), "^2 + srel_", names(observables_met), "^2 * ", names(observables_met), "^2)") %>% set_names(names(observables_met))
errors_met_sigma_NA["mom_rec_metc13"] <- 1 #hierfür gibts eh keine daten mit sigma=NA


```

```{r x g and e apapbicmet}
myodemodel <- odemodel(dxdt_dmod, modelname = "odemodel", fixed = setdiff(pars_in_dxdtdmod, c(free_pars, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.
x <- Xs(myodemodel)

g <- Y(c(observables_apap, observables_bic, observables_met), x, attach.input = F, modelname = "g", compile = F)
compile(g, output = "g")

e_sigma_NA <- Y(c(errors_bic_sigma_NA, errors_met_sigma_NA), g)#, modelname = "e", compile = F) #cant cope with NaNs passed to it, if compiled
remove_c_and_o()
```


```{r explorative plotting of offset_bic and data with estimated error bars}
blablab <- 3

datasig <- data_full %>%
  as.data.frame() %>%
  group_by(study, group, name) %>%
  mutate(nna = n(), sna = sum(is.na(sigma))) %>%
  filter(sna == nna) %>%
  select(-sna, -nna) %>%
  as.data.frame() %>%
  # mutate(sigma = sqrt(exp(-11)^2 + (value * exp(-3))^2))  %>% #Meineke
  mutate(sigma = sqrt(exp(-2-blablab)^2 + (value * exp(-3-blablab))^2))  %>% #Krumbiegel
  # mutate(sigma = sqrt(exp(0)^2 + (value * exp(-3))^2))  %>% # Barstow
  as.datalist



plotData(datasig)

# plotData(data_for_fitting %>% as.datalist()) + guides(color = F)
```

```{r data and p apapbicmet}
# Remove certain studies from the data which goes into fitting
data_for_fitting <- data_full %>% 
  filter(!str_detect(simulation, "limax")) %>% 
  filter(!str_detect(study, "Mohr2018")) %>% 
  filter(!(str_detect(study, "Albert")&str_detect(group, "capsule")))

# Split the data in datasets with and without sigma
data <- data_for_fitting  %>% filter(!is.na(sigma)) %>% select(-simulation)
data_sigma_NA <- data_for_fitting  %>% filter(is.na(sigma)) %>% select(-simulation)

# Get all parameters that in some way replace pars_raw (parameters supplied by the SBML file) or are additional parameters that we need to fit
# This could be e.g. Study specific pars such as IVDOSE* or pars that are fitted
supplied_pars <- names(pars_raw)[(names(pars_raw) %in% names(data))]
outer_pars <- sort(unique(c(free_pars, supplied_pars)))

pars_errors <- c(errors_bic_sigma_NA, errors_met_sigma_NA) %>% 
  getSymbols %>% 
  str_subset("^s") %>% 
  are_names_of(1)
outer_pars_sigma_NA <- sort(unique(c(outer_pars, names(pars_errors))))

# Define the parameter trafos which in turn define the different conditions
trafo <-
  c(pars_raw) %>% 
  sort_by_name() %>% 
  replace(names(.) %in% outer_pars, outer_pars) %>% 
  
  branch(data %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  
  insert("name ~ value", value = unlist(mget(supplied_pars)), name = supplied_pars) %>% # insert parameters supplied by the data

  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) %>% 
  {.}




trafo_sigma_NA <-
  c(pars_raw, pars_errors) %>% 
  sort_by_name() %>% 
  replace(names(.) %in% outer_pars_sigma_NA, outer_pars_sigma_NA) %>%
  
  branch(data_sigma_NA %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  insert("name ~ value", value = unlist(mget(supplied_pars)), name = supplied_pars) %>%

  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) %>% 
  
  insert("x~-11", x = str_subset(getSymbols(mytrafo[[i]]), "^S0"), conditionMatch = "Meineke1993") %>% # Fix the error parameters to a value
  insert("x~0", x = str_subset(getSymbols(mytrafo[[i]]), "^S0"), conditionMatch = "(Barstow)") %>% 
  insert("x~-3", x = str_subset(getSymbols(mytrafo[[i]]), "^SREL"), conditionMatch = "(Barstow)|(Meineke)") %>% 
  
  insert("x~0", x = str_subset(getSymbols(mytrafo[[i]]), "S((0)|(REL))_((DOB)|(P_CO2F))")) %>% 
  insert("x~x_Krumbiegel", x = str_subset(getSymbols(mytrafo[[i]]), "S((0)|(REL))")) %>% 
  {.}


p <- P(trafo, modelname = "p", compile = F)
pars <- getParameters(p) %>% are_names_of(0)

p_sigma_NA <- P(trafo_sigma_NA, modelname = "p_sig", compile = F)
pars_sigma_NA <- getParameters(p_sigma_NA) %>% are_names_of(0)


compile(p, p_sigma_NA, cores = 3, output = "p")

remove_c_and_o()
```




# dMod.frames

```{r initialize dMod_frames }
# remove(data)
apapbicmet_frame <- dMod.frame(
  hypothesis = "Weight Krumbiegel more",
  x = x,
  g = g,
  p = p,
  data = data,
  e = NULL,
  x_sig = x,
  g_sig = g,
  p_sig = list(p_sigma_NA),
  e_sig = list(e_sigma_NA),
  data_sig = list(as.datalist(data_sigma_NA)), 
  fixed = list(c("S0_CUM_REC_METC13_Krumbiegel", "SREL_CUM_REC_METC13_Krumbiegel"))
)

apapbicmet_frame <- apapbicmet_frame %>% 
  rowwise() %>% 
  appendObj() %>% 
  mutate(prd_sig = list(g_sig * x_sig * p_sig), 
         obj_data_sig = list(normL2(data_sig, prd_sig, e_sig)),
         obj = list(obj_data+ obj_data_sig),
         pars = list(structure(rnorm(length(getParameters(obj))), names =  getParameters(obj))), 
         times = list(seq(min(rbind(as.data.frame(data),as.data.frame(data_sig))[["time"]]), 
                          max(rbind(as.data.frame(data),as.data.frame(data_sig))[["time"]]) * 1.1, 
                          length.out = 200))) %>% 
  mutate(prd_data = list(prd),
         prd = list(prd_data+prd_sig), 
         data_data = list(data),
         data = list(data_data + data_sig),
         description = "Weight the data of Krumbiegel more to improve late prediction")


# apapbicmet_frame_updated_errormodel <- apapbicmet_frame
# git_add_dMod.frame(apapbicmet_frame_updated_errormodel)
# remove_c_and_o()


```


# Fit and profile with priors

```{r}
krumbiegel_frame <- apapbicmet_frame
krumbiegel_frame[["hypothesis"]] <- "prior_sigma ="

prior_sigmas <- c(0.5) 
myindices <- pars_raw %>% names %>% toupper() %>% {which(. %in% getParameters(apapbicmet_frame$p_sig[[1]]))}
prior_mu <- log(pars_raw[myindices])
names(prior_mu) <- toupper(names(prior_mu))


krumbiegel_frame <- map(1:length(prior_sigmas), function(i)
  krumbiegel_frame %>% 
    mutate(hypothesis = paste0(hypothesis, " ", prior_sigmas[i])) %>% 
    mutate(constr = list(constraintL2(prior_mu, sigma = prior_sigmas[i]))) %>% 
    mutate(obj = list(obj + constr))
  ) %>% .[[1]]


fixed <- map(1:3, function(i) {
  c("S0_CUM_REC_METC13_Krumbiegel" = -2 - i, "SREL_CUM_REC_METC13_Krumbiegel" = -3 - i)
})


krumbiegel_frame <- map(1:3, function(i) {
  krumbiegel_frame$fixed <- fixed[i]
  krumbiegel_frame$hypothesis <- paste0(krumbiegel_frame$hypothesis, ", weighting ", i)
  return(krumbiegel_frame)
}) %>% do.call(rbind,.)

```

```{r}
# insert_runbg("fit_krumbiegel", "fit", "krumbiegel_frame")
fit_krumbiegel <- runbg({
    ncores <- detectFreeCores()
    assign("ncores", ncores, pos = .GlobalEnv)

   krumbiegel_frame %>%
    ungroup %>%
    mutate(fits = map(seq_along(x), function(i) {
      assign("fit_obj", obj[[i]], pos = .GlobalEnv)
      assign("fit_pars", pars[[i]], pos = .GlobalEnv)
      assign("fit_studyname", paste0("fits", hypothesis[[i]]), pos = .GlobalEnv)
      assign("fit_fixed", fixed[[i]], pos = .GlobalEnv)
      mstrust(objfun = fit_obj, center = fit_pars, fixed = fit_fixed, studyname = fit_studyname, sd = 3,
             blather = F, cores = ncores, fits = 5*ncores) })) %>%
    rowwise

  },  machine = c(paste0("knecht", 3:5)), input = "krumbiegel_frame", filename = "2018_05_24_15_27_fit_krumbiegel_runbg"
    , recover = T
)
# fit_krumbiegel$check()
# runbg(wait_for_runbg(fit_krumbiegel), filename = "wait", input = "fit_krumbiegel")
fit_krumbiegel_results <- fit_krumbiegel$get()
# saveRDS(fit_krumbiegel_results, file = "2018_05_24_15_27_fit_krumbiegel_results.rds")
fit_krumbiegel$purge()
fit_krumbiegel <- readRDS("2018_05_24_15_27_fit_krumbiegel_results.rds")
```

```{r}
krumbiegel_frame$fits <- fit_krumbiegel_results %>% map("fits") %>% transpose() %>% map(. %>% Reduce(c.parlist,.))
krumbiegel_frame <- krumbiegel_frame %>% appendParframes()
```

```{r}
map(1:3, . %>% plotValues(krumbiegel_frame, .))
```


```{r}
plotPars(krumbiegel_frame, 1, nsteps = 3) + coord_cartesian(ylim = c(-6,5)) 
plotPars(krumbiegel_frame, 2, nsteps = 3) + coord_cartesian(ylim = c(-6,5)) 
plotPars(krumbiegel_frame, 3, nsteps = 3) + coord_cartesian(ylim = c(-6,5)) 
```


```{r}
map(1:3, . %>% plotCombined(krumbiegel_frame, ., 1))
```

```{r}
map(1:3,  . %>% {plotCombined(krumbiegel_frame, .,   getStepIndices(krumbiegel_frame$parframes[[.]], 3)[2])})
```

```{r plotting helpers}
observables <- krumbiegel_frame$g[[1]] %>% getEquations() %>%.[[1]] %>%  names

observables_apap <- "Mve_apap"
observables_bic <- c("cum_rec_co2c13", "DOB","P_CO2F")
observables_met <- c("mom_rec_metc13", "cum_rec_metc13")

conditions <- krumbiegel_frame$obj[[1]] %>% getConditions()
data <- (krumbiegel_frame$data[[1]] + krumbiegel_frame$data_sig[[1]]) %>% as.data.frame()

cond_apap <- data %>% filter(name%in%"Mve_apap") %>% .[["condition"]] %>% unique %>% as.character()
cond_bic <- data %>% filter(name%in%c("cum_rec_co2c13", "DOB","P_CO2F")) %>% .[["condition"]] %>% unique %>% as.character()
cond_met <- data %>% filter(name%in%c("mom_rec_metc13", "cum_rec_metc13")) %>% .[["condition"]] %>% unique %>% as.character()

nhyp <- nrow(krumbiegel_frame)
```

```{r plot predictions}
pdf(file = "plots_krumbiegel_weighted_more_strongly.pdf", width = 16, height = 9)
nhyp <- nrow(krumbiegel_frame)

map(1:nhyp, function(i) {
  plotCombined(krumbiegel_frame, i, 1, condition %in% cond_apap & name %in% observables_apap)
})

map(1:nhyp, function(i) {
  plotCombined(krumbiegel_frame, i, 1, condition %in% cond_bic & name %in% observables_bic)
})

map(1:nhyp, function(i) {
  plotCombined(krumbiegel_frame, i, 1, condition %in% cond_met & name %in% observables_met)
})

dev.off()
```

```{r}
# git_add_dMod.frame(krumbiegel_frame)
pars_fitted <- krumbiegel_frame$parframes[[3]] %>% as.parvec() %>% exp %>% unclass %>% sort_by_name()

myindices <- pars_raw %>% names %>% toupper() %>% {which(. %in% getParameters(apapbicmet_frame$p_sig[[1]]))}
pars_unfitted <- pars_raw[myindices] %>% sort_by_name()

# check if order is the same
names(pars_unfitted) %>% toupper() %>% identical(names(pars_fitted))

names(pars_fitted) <- names(pars_unfitted)

write_csv(data.frame(parname = names(pars_fitted),parvalue = pars_fitted), path = "pars.csv")
```


# Fit without priors
```{r}
krumbiegel_frame_wo_prior <- readRDS("2018_05_24_15_27_fit_krumbiegel_results.rds")
krumbiegel_frame_wo_prior <- krumbiegel_frame_wo_prior$knecht3
krumbiegel_frame_wo_prior <- krumbiegel_frame_wo_prior %>% 
  rowwise() %>% 
  mutate(obj = list(obj_data + obj_data_sig)) %>% 
  select(-fits) %>% 
  mutate(hypothesis = str_replace(hypothesis, "^.*,", "") )
```

```{r}
# insert_runbg("fit_krumbiegel_wo_prior", "fit", "krumbiegel_frame_wo_prior")

fit_krumbiegel_wo_prior_job <- runbg({
    ncores <- detectFreeCores()
    assign("ncores", ncores, pos = .GlobalEnv)

   krumbiegel_frame_wo_prior %>%
    ungroup %>%
    mutate(fits = map(seq_along(x), function(i) {
      assign("fit_obj", obj[[i]], pos = .GlobalEnv)
      assign("fit_pars", pars[[i]], pos = .GlobalEnv)
      assign("fit_fixed", NULL, pos = .GlobalEnv)
      # assign("fit_fixed", fixed[[i]], pos = .GlobalEnv)
      assign("fit_studyname", paste0("fits", hypothesis[[i]]), pos = .GlobalEnv)
      mstrust(objfun = fit_obj, center = fit_pars, fixed = fit_fixed, studyname = fit_studyname, sd = 3,
             blather = F, cores = ncores, fits = 5*ncores) })) %>%
    rowwise
   
   }, machine = c(paste0("knecht", c(3:5))), input = "krumbiegel_frame_wo_prior", filename = "2018_05_25_13_48_fit_krumbiegel_wo_prior_job"
  , recover = T
)
# fit_krumbiegel_wo_prior_job$check()
# runbg(wait_for_runbg(fit_krumbiegel_wo_prior_job), filename = "wait", input = "fit_krumbiegel_wo_prior_job")
# fit_krumbiegel_wo_prior <- fit_krumbiegel_wo_prior_job$get()
# fit_krumbiegel_wo_prior <- fit_krumbiegel_wo_prior %>% uniteFits()
# saveRDS(fit_krumbiegel_wo_prior, file = "fit_krumbiegel_wo_prior.rds")
fit_krumbiegel_wo_prior <- readRDS("fit_krumbiegel_wo_prior.rds")
# fit_krumbiegel_wo_prior_job$purge()
```

```{r}
fit_krumbiegel_wo_prior <- readRDS("fit_krumbiegel_wo_prior.rds")
fit_krumbiegel_wo_prior <- fit_krumbiegel_wo_prior %>% appendParframes()
# map(fit_krumbiegel_wo_prior$obj, loadDLL)

loadDLL(fit_krumbiegel_wo_prior$obj[[1]])
```


```{r plotting helpers}
observables <- fit_krumbiegel_wo_prior$g[[1]] %>% getEquations() %>%.[[1]] %>%  names

observables_apap <- "Mve_apap"
observables_bic <- c("cum_rec_co2c13", "DOB","P_CO2F")
observables_met <- c("mom_rec_metc13", "cum_rec_metc13")

conditions <- fit_krumbiegel_wo_prior$obj[[1]] %>% getConditions()
data <- (fit_krumbiegel_wo_prior$data[[1]] + fit_krumbiegel_wo_prior$data_sig[[1]]) %>% as.data.frame()

cond_apap <- data %>% filter(name%in%"Mve_apap") %>% .[["condition"]] %>% unique %>% as.character()
cond_bic <- data %>% filter(name%in%c("cum_rec_co2c13", "DOB","P_CO2F")) %>% .[["condition"]] %>% unique %>% as.character()
cond_met <- data %>% filter(name%in%c("mom_rec_metc13", "cum_rec_metc13")) %>% .[["condition"]] %>% unique %>% as.character()

nhyp <- nrow(fit_krumbiegel_wo_prior)
```

```{r}
plotPars(fit_krumbiegel_wo_prior, 1:3, nsteps = 1)
```




```{r plot predictions}
pdf(file = "plots_krumbiegel_wo_prior.pdf", width = 16, height = 9)
nhyp <- nrow(fit_krumbiegel_wo_prior)

map(1:nhyp, function(i) {
  plotCombined(fit_krumbiegel_wo_prior, i, 1, condition %in% cond_apap & name %in% observables_apap)
})

map(1:nhyp, function(i) {
  plotCombined(fit_krumbiegel_wo_prior, i, 1, condition %in% cond_bic & name %in% observables_bic)
})

map(1:nhyp, function(i) {
  plotCombined(fit_krumbiegel_wo_prior, i, 1, condition %in% cond_met & name %in% observables_met)
})

dev.off()
```

```{r}
# git_add_dMod.frame(fit_krumbiegel_wo_prior)
pars_fitted <- fit_krumbiegel_wo_prior$parframes[[3]] %>% as.parvec() %>% exp %>% unclass %>% sort_by_name()

myindices <- pars_raw %>% names %>% toupper() %>% {which(. %in% getParameters(apapbicmet_frame$p_sig[[1]]))}
pars_unfitted <- pars_raw[myindices] %>% sort_by_name()

# check if order is the same
names(pars_unfitted) %>% toupper() %>% identical(names(pars_fitted))

names(pars_fitted) <- names(pars_unfitted)

write_csv(data.frame(parname = names(pars_fitted),parvalue = pars_fitted), path = "pars.csv")
```




# Analysis of results

```{r}
prior_frame <- readRDS("2018_05_18_19_53_profile_steps_results.rds")$knecht2
walk(prior_frame$obj, loadDLL)
walk(1:nrow(prior_frame), function(i) {
  controls(prior_frame$g[[i]], name = "attach.input") <- T
  controls(prior_frame$g_sig[[i]], name = "attach.input") <- T
  controls(prior_frame$prd[[i]], name = "attach.input") <- T
  controls(prior_frame$prd_data[[i]], name = "attach.input") <- T
  controls(prior_frame$prd_sig[[i]], name = "attach.input") <- T
})

```


```{r plotting helpers}
observables <- prior_frame$g[[1]] %>% getEquations() %>%.[[1]] %>%  names

observables_apap <- "Mve_apap"
observables_bic <- c("cum_rec_co2c13", "DOB","P_CO2F")
observables_met <- c("mom_rec_metc13", "cum_rec_metc13")

conditions <- prior_frame$obj[[1]] %>% getConditions()
data <- (prior_frame$data[[1]] + prior_frame$data_sig[[1]]) %>% as.data.frame()

cond_apap <- data %>% filter(name%in%"Mve_apap") %>% .[["condition"]] %>% unique %>% as.character()
cond_bic <- data %>% filter(name%in%c("cum_rec_co2c13", "DOB","P_CO2F")) %>% .[["condition"]] %>% unique %>% as.character()
cond_met <- data %>% filter(name%in%c("mom_rec_metc13", "cum_rec_metc13")) %>% .[["condition"]] %>% unique %>% as.character()

nhyp <- nrow(prior_frame)
```

```{r plot values}
map(1:nhyp, . %>% plotValues(prior_frame, .))
```


```{r plot pars}
map(1:nhyp, function(i) {
  plotPars(prior_frame, i, nsteps = 4)
})
```

```{r plot predictions}
pdf(file = "plots_new.pdf", width = 16, height = 9)

map(1:nhyp, function(i) {
  plotCombined(prior_frame, i, 1, condition %in% cond_apap & name %in% observables_apap)
})

map(1:nhyp, function(i) {
  plotCombined(prior_frame, i, 1, condition %in% cond_bic & name %in% observables_bic)
})

map(1:nhyp, function(i) {
  plotCombined(prior_frame, i, 1, condition %in% cond_met & name %in% observables_met)
})

dev.off()

```


```{r plot Profiles}
prior_frame$profiles %>% 
  setNames(prior_frame$hypothesis) %>% 
  plotProfile() +
  coord_cartesian(ylim = c(-0.5, 4))


# ggplotly()
```

# Find out what to do about the bic data
1. Is the assumed error model correct?
  - No for P_CO2F, the absolute error is too big!
2. What about the offset? Should I do it correctly or can I just fix the offset?
```{r explorative plotting of offset_bic and data with estimated error bars}
# checkout_hypothesis(prior_frame, 4, "wup")
dev.new()
wuppars <- wupparframes %>% as.parvec()
wuppars["offset_bic"] <- wuppars["offset_bic"] - .00004

wupdata_sig <- wupdata_sig %>% as.data.frame() %>% 
  mutate(sigma = sqrt(exp(-2)^2+ value * exp(-1)^2))  %>% 
  select(-condition) %>% 
  as.datalist

wupdata <- wupdata_data + (wupdata_sig)

plotCombined(wupprd(wuptimes, wuppars, deriv = F), NULL, condition %in% cond_bic & name %in% "P_CO2F") + 
  ggplot2::geom_hline(yintercept = 0)

plotData(wupdata, name %in% observables_bic)
```




## Question: Which conditions push the parameter CYP1A2MET_KM_MET to -Inf?
```{r}
prior_frame <-
  prior_frame %>% 
  rowwise() %>% 
  mutate(condwise_data = list(obj_condition_wise(obj_data, parframes %>% as.parvec)),
         condwise_sum = list(obj_condition_wise(obj, parframes %>% as.parvec)),
         condwise_constr = list(obj_condition_wise(constr, parframes %>% as.parvec)))
```

Look at the conditions in hypothesis 4
```{r}
unnest_name <- function(myframe, unique = "condition", unnest_var = "gradient") {
  myframe_2 <- myframe %>% .[c(unique, unnest_var)]
  myframe_2 <- myframe_2 %>% apply(1, function(i) {
    tibble(condition = i[[unique]], grad_value = unlist(i[[unnest_var]]), grad_name = unlist(names(i[[unnest_var]])))
  }) %>% do.call(rbind,.)
  
  left_join(myframe, myframe_2)
}

prior_frame$condwise_data[[4]] %>% 
  do.call(rbind,.) %>% 
  unnest_name() %>% 
  ggplot(aes(y = grad_name, x = grad_value, color = condition)) + 
  geom_point()

# ggplotly()


git_add_dMod_frame("2018_04_23_17_00_prior.frame_full.rds")
```

```{r}
prior_frame$condwise_data[[4]] %>% 
  do.call(rbind,.) %>% 
  unnest_name() %>% 
  group_by(grad_name) %>%
  mutate(sum_val = sum(grad_value)) %>% 
  ggplot(aes(y = grad_name, x = sum_val, color = condition)) + 
  geom_point()
```

```{r}
prior_frame$condwise_sum[[4]] %>% 
  do.call(rbind,.) %>% 
  unnest_name() %>% 
  group_by(grad_name) %>%
  mutate(sum_val = sum(grad_value)) %>% 
  arrange(desc(sum_val), grad_name)
  ggplot(aes(y = grad_name, x = sum_val, color = condition)) + 
  geom_point() 
```

```{r}
prior_frame <- prior_frame %>% 
  mutate(val_sum = list(obj(parframes %>% as.parvec)),
         val_data = list(obj_data(parframes %>% as.parvec)),
         val_constr = list(constr(parframes %>% as.parvec)))
```

```{r}
prior_frame$val_sum[[4]]$gradient
```


```{r}
unnest_name(myframe) %>% print
```






```{r}
# prior_frame$obj %>% walk(loadDLL)
prior_frame %>% 
  plotCombined(4,1, str_detect(name, "rec"))
prior_frame %>% 
  plotCombined(4,98, str_detect(name, "rec"))
prior_frame %>% 
  plotCombined(4,518, str_detect(name, "rec"))

# plotResiduals.dMod.frame(prior_frame,4, split = "condition") # TODO
```



## Plot the fluxes
Create reactions, a dMod-object which contains the stoichiometric matrix.
```{r, dependson="read_model"}
symbolic <- readr::read_lines("../model/limax_pkpd_v41.R", 649, 693-649)
mynames <- symbolic  %>%  str_split( "=", simplify = T) %>% .[,1] %>% str_replace_all(c(" "= "", "^ " = "", "^d" = ""))
equations <- symbolic  %>%  str_split( "=", simplify = T) %>% .[,2] %>% str_replace_all(c(" "= "", "^ " = "", "^d" = "", "," = ""))
ratenames <- getSymbols(c(equations)) %>% str_subset_not("^p")

S_preliminary <- outer(equations, ratenames, str_detect) # "Where do the reactions appear"?
S_negative <- outer(equations, paste0("\\-", ratenames), str_detect) # "Where do they appear with a negative sign"?
S <- (S_preliminary - 2 * S_negative) %>% t %>% magrittr::set_colnames(mynames)

rates <- y_dmod[ratenames]

reactions <- data.frame(Description = ratenames, Rate = rates, S, stringsAsFactors = F) %>% as.eqnlist()
```

Fuller and Leijssen are the only ones which have Ri_co2c13 unequal zero.
```{r}
pr1_data %>% covariates()
```

```{r}
reactions %>%
  as.data.frame() %>% 
  filter(Rate %>% str_detect("KBO"))


reactions %>% as.data.frame() %>% 
  filter(Rate %>% str_detect("Ri_co2c13"))


plotFluxes(pr1_parframes %>% as.parvec(98), pr1_prd, seq(0,20*max(pr1_times), length.out = 500), rates %>% str_subset("KBO")) %>% 
  attr("out") %>% 
  spread()

```


```{r}
checkout_hypothesis(prior_frame, 4, "pr1_")

plotFluxes(pr1_parframes %>% as.parvec(98), pr1_prd, seq(0,20*max(pr1_times), length.out = 500), rates %>% str_subset("KBO")) %>% attr("out") %>% 
  mutate(condition = as.character(condition) %>% str_trunc(17)) %>% 
  ggplot(aes(time, value, fill = name)) + 
  geom_area(aes(ymax = value)) +
  facet_wrap("condition", scales = "free_y") + 
  guides(fill = F)



```



```{r}
myobjvals <- obj_condition_wise(pr1_obj_data, pr1_parframes %>% as.parvec)

myobjvals %>% 
  conveniencefunctions:::unnest_name() %>% 
  mutate(condition = as.character(condition) %>% str_trunc(17)) %>% 
  ggplot(aes(grad_value, grad_name)) + 
  geom_point(aes(color = condition))

ggplotly()
```





# Profile around optimum of priorsig=1 without prior


```{r}
myframe <- prior_frame[4,]
myframe$obj %>% walk(loadDLL)
profile_without_prior_after_refitting <- runbg({
    ncores <- detectFreeCores()
    assign("ncores", ncores, pos = .GlobalEnv)

   myframe %>%
    ungroup %>%
     mutate(profiles_wo_prior_after_refitting = map(seq_along(x), function(i) {
       assign("fit_obj", obj[[i]], pos = .GlobalEnv)
       assign("fit_pars", parframes[[i]] %>% as.parvec, pos = .GlobalEnv)

       mynames <- names(fit_pars)

       parallel::mclapply(mynames, function(nm) {
         mypars <- trust(fit_obj, fit_pars[!names(fit_pars)%in%nm], fixed = fit_pars[nm], 0.5, 2, iterlim = 50)$argument
         profile(obj = fit_obj, pars = c(mypars, fit_pars[nm]), whichPar = nm, cores = 2) }, mc.cores = ncores) %>%
         do.call(rbind,.)
     })) %>%
       rowwise



  },  machine = c(paste0("knecht", 2)), input = "myframe", filename = "2018_05_14_14_14_profile_without_prior_after_refitting_runbg"
    ,recover = T
)
profile_without_prior_after_refitting$check()
# runbg(wait_for_runbg(profile_without_prior_after_refitting), filename = "wait", input = "profile_without_prior_after_refitting")
profile_without_prior_after_refitting_results <- profile_without_prior_after_refitting$get()
# saveRDS(profile_without_prior_after_refitting_results, file = "2018_05_14_14_14_profile_without_prior_after_refitting_results.rds")
# profile_without_prior_after_refitting$purge()
# profile_without_prior_after_refitting <- readRDS("2018_05_14_14_14_profile_without_prior_after_refitting_results.rds")
```
```{r}
profile_without_prior_after_refitting_results$knecht2$profiles_wo_prior_after_refitting 
```



```{r}
# myframe <- prior_frame[4,]
# profile_without_prior <- runbg({
#     ncores <- detectFreeCores()
#     assign("ncores", ncores, pos = .GlobalEnv)
# 
#    myframe %>%
#     ungroup %>%
#     mutate(profiles_wo_prior = map(seq_along(x), function(i) {
#       
#       myobj <- obj_data[[i]]+obj_data_sig[[i]]
#       assign("fit_obj", myobj, pos = .GlobalEnv)
#       assign("fit_pars", parframes[[i]] %>% as.parvec, pos = .GlobalEnv)
#       profile(obj = fit_obj, pars = fit_pars, whichPar = names(fit_pars), cores = ncores) })) %>%
#       rowwise
# 
# 
#   },  machine = c(paste0("knecht", 5)), input = "myframe", filename = "2018_05_11_20_13_profile_without_prior_runbg")
# saveRDS(profile_without_prior, file = "2018_05_11_20_13_profile_without_prior.rds")
# profile_without_prior <- readRDS("2018_05_11_20_13_profile_without_prior.rds")
# profile_without_prior$check()
# wait_for_runbg(profile_without_prior)
# profile_without_prior_results <- profile_without_prior$get()
# saveRDS(profile_without_prior_results, file = "2018_05_11_20_13_profile_without_prior_results.rds")
# profile_without_prior$purge()
profile_without_prior <- readRDS("2018_05_11_20_13_profile_without_prior_results.rds")
```

```{r}
profile_without_prior$knecht5$profiles_wo_prior %>% plotProfile()
```





# Port dMod.frame to Shiny-App

Create reactions, a dMod-object which contains the stoichiometric matrix.
```{r, dependson="read_model"}
symbolic <- readr::read_lines("../model/limax_pkpd_v41.R", 649, 693-649)
mynames <- symbolic  %>%  str_split( "=", simplify = T) %>% .[,1] %>% str_replace_all(c(" "= "", "^ " = "", "^d" = ""))
equations <- symbolic  %>%  str_split( "=", simplify = T) %>% .[,2] %>% str_replace_all(c(" "= "", "^ " = "", "^d" = "", "," = ""))
ratenames <- getSymbols(c(equations)) %>% str_subset_not("^p")

S_preliminary <- outer(equations, ratenames, str_detect) # "Where do the reactions appear"?
S_negative <- outer(equations, paste0("\\-", ratenames), str_detect) # "Where do they appear with a negative sign"?
S <- (S_preliminary - 2 * S_negative) %>% t %>% magrittr::set_colnames(mynames)

rates <- y_dmod[ratenames]

reactions <- data.frame(Description = ratenames, Rate = rates, S, stringsAsFactors = F) %>% as.eqnlist()
```



```{r}
prior_frame <- readRDS("2018_05_11_17_26_prior_frame.rds")
walk(prior_frame$obj, loadDLL)
walk(1:nrow(prior_frame), function(i) {
  controls(prior_frame$g[[i]], name = "attach.input") <- T
  controls(prior_frame$g_sig[[i]], name = "attach.input") <- T
  controls(prior_frame$prd[[i]], name = "attach.input") <- T
  controls(prior_frame$prd_data[[i]], name = "attach.input") <- T
  controls(prior_frame$prd_sig[[i]], name = "attach.input") <- T
})

# plotCombined(prior_frame,1,1)

prior_frame <- prior_frame %>% 
  mutate(reactions = map(seq_along(x), function(i) reactions)) %>% 
  mutate(sigma = str_replace_all(hypothesis, c("srel = -1,s0=-2, " = "", "=" = "", " " = "", "\\." = "")))#%>% str_replace("\\.", ""))

# prior_frame$sigma

walk(c(3,4,7,6), function(i) {
  saveShiny_dMod.frame(prior_frame, i, projectname = paste0("LiMaX", prior_frame$sigma[i]))
})


```











