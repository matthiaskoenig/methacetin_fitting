---
title: "Fitting model 39"
output: 
  html_document:
    toc: TRUE
---


Load all important libraries
```{r setup, message=FALSE, warning=FALSE, eval=TRUE, echo=FALSE}
knitr::opts_chunk$set(eval = TRUE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(fig.width = 15)
library(dMod)
library(stringr) # Um bequem mit strings zu arbeiten
library(tidyverse) # Viele Funktionen, u.a. für data.frames und ggplot2 für schöne plots
library(magrittr) # der Pipe-operator %>%: z.B: x =" a; y="f(x); z="g(y); wird zu z=" a %>% f %>% g
library(conveniencefunctions)
```


# Read model
```{r}
source("../model/limax_pkpd_v41.R")
```


```{r}
pars_raw <- c(x0, p) 
pars_in_dxdtdmod <- c(getSymbols(dxdt_dmod), names(dxdt_dmod))
```

# Odemodels and predicition function

## Apap
```{r odemodel_apap}
free_pars_apap <- c("Ka_apap", "APAPD_HLM_CL", "APAPD_Km_apap")
odemodel_apap <- odemodel(dxdt_dmod, modelname = "odemodel_apap", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_apap, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_apap <- Xs(odemodel_apap)
```


## Bicarbonate

```{r odemodel_bic}
free_pars_bic <- c("Ka_co2c13", "KLU_EXCO2", "CO2FIX_HLM_CL", "KBO_FIXCO2", "KBO_RELCO2", "KBO_MAXCO2")
odemodel_bic <- odemodel(dxdt_dmod, modelname = "odemodel_bic", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_bic, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_bic <- Xs(odemodel_bic)
```

## Metc13

```{r odemodel_met}
free_pars_met <- c("Ka_metc13", "CYP1A2MET_CL", "CYP1A2MET_Km_met")
odemodel_met <- odemodel(dxdt_dmod, modelname = "odemodel_met", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_met, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_met <- Xs(odemodel_met)
```


# Observation functions

## Apap

```{r g_apap}
observables_apap <- y_dmod[c("Mve_apap")] %>% set_names(c("Mve_apap"))
g_apap <- Y(g = observables_apap, f = x_apap, attach.input = F, modelname = "g_apap", compile = F)
```

## Bicarbonate

```{r g_bic}
recovery_bic <- paste(y_dmod["Exhalation_co2c13"], "/ 60 * Mr_co2c13 / Ri_co2c13 * 100")
observables_bic <- c(recovery_bic, y_dmod[c("DOB", "P_CO2Fc13")])
names(observables_bic) <- c("cum_rec_co2c13", "DOB", "P_CO2F")

observables_bic["P_CO2F"] <- paste0(observables_bic["P_CO2F"], " + offset_bic")

g_bic <- Y(observables_bic, x_bic, attach.input = F, modelname = "g_bic", compile = F)
```

## Metc13

```{r g_met}
recovery_met <- paste(y_dmod["Exhalation_co2c13"], "/ init_PODOSE_metc13 * Mr_metc13 * 100" )
cum_met <- paste( "Abreath_co2c13/ init_PODOSE_metc13 * Mr_metc13 * 100")
observables_met <- c(recovery_met, cum_met) %>% set_names(c("mom_rec_metc13", "cum_rec_metc13"))

g_met <- Y(observables_met, x_met, attach.input = F, modelname = "g_met", compile = F)
```



# Data - read and preprocess
Read data, insert the default values for the parameters supplied in the data sheet. 

* Taheri rausschmeißen zum Fitten: Wird weiter unten getan

```{r, message=FALSE}
data <-
  read_tsv("../data/limax_pkpd_v41_data.csv") %>%
  select(-model) %>% 
  rename(name = observer) %>% 
  rename(n = subjects) %>% 
  unique() #noch matthias sagen, dass lalazar2008 doppelte einträge hat


fitErrorModel_factors <- c("study", "group", "name", "BW", "PODOSE_apap", "IVDOSE_apap", 
"PODOSE_co2c13", "IVDOSE_co2c13", "Ri_co2c13", "ti_co2c13", "PODOSE_metc13", 
"IVDOSE_metc13", "ti_metc13")
some_na <-
  data %>% 
  group_by(study, group, name) %>% 
  mutate(nna = n(), sna = sum(is.na(sigma))) %>% 
  filter(sna>0 & sna != nna) %>% 
  select(-sna, -nna) %>% 
  as.data.frame() %>% 
  fitErrorModel(factors = fitErrorModel_factors, plotting = F, blather = F) 

none_or_all_na <- data %>% 
  group_by(study, group, name) %>% 
  mutate(nna = n(), sna = sum(is.na(sigma))) %>% 
  filter(sna==0 | sna == nna) %>% 
  select(-sna, -nna) %>% 
  as.data.frame()

data <- rbind(some_na, none_or_all_na) %>% 
  select(-n)

supplied_pars <- names(pars_raw)[(names(pars_raw) %in% names(data))]

# data %>% 
#   group_by(study, group, name) %>% 
#   mutate(nna = n(), sna = sum(is.na(sigma))) %>% 
#   filter(!sna == nna) %>% 
#   select(-sna, -nna) %>% 
#   as.data.frame() %>% 
#   fitErrorModel(factors = fitErrorModel_factors, plotting = T, blather = F)
# ggsave("~/Promotion/Writing/Presentations/2018 04 03 Peter Jansen LiSyM/Limax/Errormodels.png")

```


# Parameter trafos
## Apap
```{r p_apap}
data_apap <- data %>%  
  filter(simulation == "apap") %>% 
  select(-simulation) %>% 
  as.data.frame()
  
outer_pars_apap <- sort(c(supplied_pars, free_pars_apap))

trafo_apap <-
  pars_raw %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_apap), outer_pars_apap) %>% 
  
  branch(data_apap %>% as.datalist() %>% covariates()) %>% 
  
  minsert(supplied_pars) %>% 
  
  insert("x~exp(X)", x = free_pars_apap, X = toupper(free_pars_apap)) # backtrafo to linear pars from log-pars

p_apap <- P(trafo_apap, modelname = "p_apap", compile = F)

pars_apap <- log(pars_raw[free_pars_apap]) %>% set_names(toupper(free_pars_apap))

compile(g_apap, p_apap, output = "apap")

```

### Test plot
```{r plot_apap, eval=TRUE}
# loadDLL(x_apap)
times <- seq(0,24, 0.1)
plotCombined((g_apap*x_apap*p_apap)(times, pars_apap, deriv = F), data = data_apap %>% as.datalist(), name %in% names(observables_apap))

obj <- normL2(data_apap %>% as.datalist, (g_apap*x_apap*p_apap))
obj(getParameters(obj) %>% are_names_of(0))
```

## Bicarbonate

Some studies don't have sigmas. Estimate the errors for them while fitting. For this, we need to define an error model.
1. Split the data into studies a) with errors "_bic" and b) without errors "_bic_sigma_NA"
2. Define the error model (technically, this will also be an observation function: It "observes" the outputs of the model, e.g. "recovery", and calculates another variable from it, the error)
3. For both sets of data, "_bic", and "bic_sigma_NA", we now need condition specific parameters. Additionally, in "_bic_sigma_NA", we need to supply the parameters of our error model.

### Error model

```{r e_bic}
data_bic <- data %>% 
  filter(simulation == "bicarbonate")%>% 
  select(-simulation) %>% 
  as.data.frame()

studies_with_sigma_na <- data_bic %>% filter(is.na(sigma)) %>% .[["study"]] %>% unique
data_bic_sigma_NA <- data_bic %>% filter(study %in% studies_with_sigma_na)
data_bic <- data_bic %>% filter(! study %in% studies_with_sigma_na)

data_bic_sigma_NA$name %>% unique()

errors_bic_sigma_NA <- paste0("sqrt(s0_", names(observables_bic), "^2 + srel_", names(observables_bic), "^2 * ", names(observables_bic), "^2 )") %>% set_names(names(observables_bic))
errors_bic_sigma_NA["cum_rec_co2c13"] <- 1 #hierfür gibts eh keine daten und ich weiß nicht, ob ich es einfach weglassen kann

e_bic_sigma_NA <- Y(g = errors_bic_sigma_NA, f= (g_bic))
```

### Parameter trafo
```{r p_bic}
outer_pars_bic <- sort(c(supplied_pars, free_pars_bic))

trafo_bic<-
  c(pars_raw) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_bic), outer_pars_bic) %>% 
  
  branch(data_bic %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  
  minsert(supplied_pars) %>% 

  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) %>% 
  
  define("x~x", x = "offset_bic")

p_bic <- P(trafo_bic, modelname = "p_bic", compile = F)

pars_bic <- getParameters(p_bic) %>% are_names_of(0)
```

```{r p_bic_sigma_NA}
pars_errors_bic_sigma_NA <- getSymbols(errors_bic_sigma_NA) %>% str_subset("^s") %>% are_names_of(1)

outer_pars_bic <- sort(c(supplied_pars, free_pars_bic, names(pars_errors_bic_sigma_NA)))

trafo_bic_sigma_NA <-
  c(pars_raw, pars_errors_bic_sigma_NA) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_bic), outer_pars_bic) %>% 
  
  branch(data_bic_sigma_NA %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  
  minsert(supplied_pars) %>% 
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) %>% 
  
  define("x~x", x = "offset_bic")

p_bic_sigma_NA <- P(trafo_bic_sigma_NA, modelname = "p_bic_sig", compile = F)

pars_bic_sigma_NA <- getParameters(p_bic_sigma_NA) %>% are_names_of(0)

# p_bic_sigma_NA(pars_bic_sigma_NA)

compile(g_bic, p_bic, p_bic_sigma_NA, output = "bic")
```


### Example plot
```{r}
loadDLL(x_bic)
(g_bic*x_bic*p_bic_sigma_NA)(times*10, pars_bic_sigma_NA, deriv = F) %>%  plotPrediction(name %in% names(observables_bic))
(g_bic*x_bic*p_bic)(times*10, pars_bic, deriv = F) %>%  
  # lapply(. %>% as.tibble)
  plotPrediction(name %in% names(observables_bic))
# obj <- normL2(data_bic %>% as.datalist,(g_bic*x_bic*p_bic))

```


## Metc13

The same game for the data sets without sigmas applies here. Read the description for Bic.

### Error model
```{r e_met}
data_met <- data %>% 
  filter(simulation == "methacetin")%>% 
  select(-simulation) %>% 
  as.data.frame()

studies_with_sigma_na <- data_met %>% filter(is.na(sigma)) %>% .[["study"]] %>% unique
data_met_sigma_NA <- data_met %>% filter(study %in% studies_with_sigma_na)
data_met <- data_met %>% filter(! study %in% studies_with_sigma_na)

errors_met_sigma_NA <- paste0("sqrt(s0_", names(observables_met), "^2 + srel_", names(observables_met), "^2 * ", names(observables_met), "^2)") %>% set_names(names(observables_met))
errors_met_sigma_NA["mom_rec_metc13"] <- 1 #hierfür gibts eh keine daten mit sigma=NA

e_met_sigma_NA <- Y(g = errors_met_sigma_NA, f= (g_met))


```

### Parameter trafo
```{r p_met}
outer_pars_met <- sort(c(supplied_pars, free_pars_met))

trafo_met<-
  c(pars_raw) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_met), outer_pars_met) %>% 
  
  branch(data_met %>% as.datalist() %>% covariates()) %>%  # The table of covariates includes dosepar and dose, which are used in the next line
  
  minsert(supplied_pars) %>% 

  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters
    
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) 

p_met <- P(trafo_met, modelname = "p_met", compile = F)

pars_met <- getParameters(p_met) %>% are_names_of(0)
```


```{r p_met_sigma_NA}
pars_errors_met_sigma_NA <- getSymbols(errors_met_sigma_NA) %>% str_subset("^s") %>%  are_names_of(1)

outer_pars_met <- sort(c(supplied_pars, free_pars_met, names(pars_errors_met_sigma_NA)))

trafo_met_sigma_NA <-
  c(pars_raw, pars_errors_met_sigma_NA) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_met), outer_pars_met) %>% 
  
  branch(data_met_sigma_NA %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  
  minsert(supplied_pars) %>% 
  
  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]])))



p_met_sigma_NA <- P(trafo_met_sigma_NA, modelname = "p_met_sig", compile = F)

pars_met_sigma_NA <- getParameters(p_met_sigma_NA) %>% are_names_of(0)

compile(g_met, p_met, p_met_sigma_NA, output = "met")
```

### Example plot
```{r}
loadDLL(x_met)
(g_met*x_met*p_met_sigma_NA)(times*100, pars_met_sigma_NA, deriv = F) %>% plotPrediction(name %in% names(observables_met))
```



# Bic and met together
```{r x, g and e bicmet}
free_pars_bicmet <- c(free_pars_bic, free_pars_met)
odemodel_bicmet <- odemodel(dxdt_dmod, modelname = "odemodel_bicmet", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_bicmet, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.
x_bicmet <- Xs(odemodel_bicmet)

g_bicmet <- Y(c(observables_bic, observables_met), x_bicmet, attach.input = F, modelname = "g_bicmet", compile = F)

e_bicmet <- Y(c(errors_bic_sigma_NA, errors_met_sigma_NA), g_bicmet)# , modelname = "e_bicmet", compile = F)
```

```{r data and p bicmet}
data_bicmet <- rbind(data_bic, data_met)
data_bicmet_sigma_NA <- rbind(data_bic_sigma_NA, data_met_sigma_NA)

outer_pars_bic <- sort(c(supplied_pars, free_pars_bic))
outer_pars_bic_sigma_NA <- sort(c(supplied_pars, free_pars_bic, names(pars_errors_bic_sigma_NA)))

outer_pars_met <- sort(c(supplied_pars, free_pars_met))
outer_pars_met_sigma_NA <- sort(c(supplied_pars, free_pars_met, names(pars_errors_met_sigma_NA)))

trafo_bicmet<-
  c(pars_raw) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% unique(c(outer_pars_bic, outer_pars_met))), sort(unique(c(outer_pars_bic, outer_pars_met)))) %>% 
  
  branch(data_bicmet %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  
  minsert(supplied_pars) %>% 

  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters

  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) %>% 
  
  define("x~x", x = "offset_bic")


trafo_bicmet_sigma_NA <-
  c(pars_raw, pars_errors_bic_sigma_NA, pars_errors_met_sigma_NA) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% unique(c(outer_pars_bic_sigma_NA, outer_pars_met_sigma_NA))), sort(unique(c(outer_pars_bic_sigma_NA, outer_pars_met_sigma_NA)))) %>% 
  
  branch(data_bicmet_sigma_NA %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  minsert(supplied_pars) %>% 
  #bic

  #met
  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters

  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) %>% 
  

  define("x~x", x = "offset_bic") %>% 
  
  #met
  {.}


p_bicmet <- P(trafo_bicmet, modelname = "p_bicmet", compile = F)
pars_bicmet <- getParameters(p_bicmet) %>% are_names_of(0)

p_bicmet_sigma_NA <- P(trafo_bicmet_sigma_NA, modelname = "p_sig_bicmet", compile = F)
pars_bicmet_sigma_NA <- getParameters(p_bicmet_sigma_NA) %>% are_names_of(0)

compile(g_bicmet, p_bicmet, p_bicmet_sigma_NA, cores = 3, output = "bicmet")
```

# Apap, bic and met

```{r x, g and e apapbicmet}
free_pars_apapbicmet <- c(free_pars_apap, free_pars_bic, free_pars_met)
odemodel_apapbicmet <- odemodel(dxdt_dmod, modelname = "odemodel_apapbicmet", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_apapbicmet, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.
x_apapbicmet <- Xs(odemodel_apapbicmet)

g_apapbicmet <- Y(c(observables_apap, observables_bic, observables_met), x_apapbicmet, attach.input = F, modelname = "g_apapbicmet", compile = F)

e_apapbicmet <- Y(c(errors_bic_sigma_NA, errors_met_sigma_NA), g_apapbicmet)#, modelname = "e_apapbicmet", compile = F) #cant cope with NaNs passed to it, if compiled
```

```{r data and p apapbicmet}
data_apapbicmet <- rbind(data_apap, data_bic, data_met)
data_apapbicmet_sigma_NA <- rbind(data_bic_sigma_NA, data_met_sigma_NA)

outer_pars_apap <- sort(c(supplied_pars,free_pars_apap))

outer_pars_bic <- sort(c(supplied_pars, free_pars_bic))
outer_pars_bic_sigma_NA <- sort(c(supplied_pars, free_pars_bic, names(pars_errors_bic_sigma_NA)))

outer_pars_met <- sort(c(supplied_pars, free_pars_met))
outer_pars_met_sigma_NA <- sort(c(supplied_pars, free_pars_met, names(pars_errors_met_sigma_NA)))

outer_pars_apapbicmet <- sort(unique(c(outer_pars_apap, outer_pars_bic, outer_pars_met)))
outer_pars_apapbicmet_sigma_NA <- sort(unique(c(outer_pars_apap, outer_pars_bic, outer_pars_bic_sigma_NA, outer_pars_met,outer_pars_met_sigma_NA)))

trafo_apapbicmet<-
  c(pars_raw) %>% 
  sort_by_name() %>% 
  replace(names(.) %in% outer_pars_apapbicmet, outer_pars_apapbicmet) %>% 
  
  branch(data_apapbicmet %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  
  minsert(supplied_pars) %>% 
  
  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) %>% 
  
  define("x~x", x = "offset_bic")


trafo_apapbicmet_sigma_NA <-
  c(pars_raw, pars_errors_bic_sigma_NA, pars_errors_met_sigma_NA) %>% 
  sort_by_name() %>% 
  replace(names(.) %in% outer_pars_apapbicmet_sigma_NA, outer_pars_apapbicmet_sigma_NA) %>% 
  
  branch(data_apapbicmet_sigma_NA %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  minsert(supplied_pars) %>% 
  #bic

  #met
  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) %>% 
  
  #bic
  define("x~x", x = "offset_bic") %>% 
  
  #met
  {.}



p_apapbicmet <- P(trafo_apapbicmet, modelname = "p_apapbicmet", compile = F)
pars_apapbicmet <- getParameters(p_apapbicmet) %>% are_names_of(0)

p_apapbicmet_sigma_NA <- P(trafo_apapbicmet_sigma_NA, modelname = "p_sig_apapbicmet", compile = F)

pars_apapbicmet_sigma_NA <- getParameters(p_apapbicmet_sigma_NA) %>% are_names_of(0)


compile(g_apapbicmet,  p_apapbicmet, p_apapbicmet_sigma_NA, cores = 3, output = "apapbicmet")
```


# dMod.frames

```{r initialize dMod.frames }
# remove(basic_hypotheses.frame, bicmet.frame, apapbicmet.frame)

basic_hypotheses.frame <- tibble(hypothesis = c("apap",  "bic", "met"),
                     x = list(x_apap,  x_bic, x_met)) %>% 
  add_column( g = list(g_apap,  g_bic, g_met)) %>% 
  add_column(p_0 = list(p_apap,  p_bic, p_met),
             data_0 = list(data_apap,  data_bic, data_met),
             p_sig = list(NULL,  p_bic_sigma_NA, p_met_sigma_NA),
             e = list(NULL,  e_bic_sigma_NA, e_met_sigma_NA),
             data_sig = list(NULL,  data_bic_sigma_NA, data_met_sigma_NA)
  )
# basic_hypotheses.frame <- basic_hypotheses.frame[1,] # keep only apap

bicmet.frame <- tibble(
  hypothesis = "bicmet",
  x = list(x_bicmet),
  g = list(g_bicmet),
  p_0 = list(p_bicmet),
  data_0 = list(data_bicmet),
  p_sig = list(p_bicmet_sigma_NA),
  e = list(e_bicmet),
  data_sig = list(data_bicmet_sigma_NA)
)

apapbicmet.frame <- tibble(
  hypothesis = "apapbicmet",
  x = list(x_apapbicmet),
  g = list(g_apapbicmet),
  p_0 = list(p_apapbicmet),
  data_0 = list(data_apapbicmet),
  p_sig = list(p_apapbicmet_sigma_NA),
  e = list(e_apapbicmet),
  data_sig = list(data_apapbicmet_sigma_NA)
)

```


# Prepare fits

```{r functions for dMod.frames to create objfuns and make them frame smaller again}
dMf_append_objfuns <- function(dMod.frame) dMod.frame %>% 
    mutate(data_0 = map(data_0, as.datalist),
         data_sig = map(data_sig, as.datalist)) %>% 
  mutate(prd_0 = map(seq_along(x), function(i) cfn(g[[i]], cfn(x[[i]],p_0[[i]]))),
         prd_sig = map(seq_along(x), function(i) cfn(g[[i]], cfn(x[[i]],p_sig[[i]])))) %>% 
  mutate(obj_0 = map(seq_along(x), function(i) normL2(data_0[[i]], prd_0[[i]])),
         obj_sig = map(seq_along(x), function(i) cf_normL2(data = data_sig[[i]], prd_sig[[i]], e = e[[i]]))) %>% 
  
  mutate(obj = map(seq_along(x), function(i) obj_sig[[i]]+obj_0[[i]])) %>% 
  mutate(prd = map(seq_along(x), function(i) prd_sig[[i]]+prd_0[[i]])) %>% 
  mutate(data= map(seq_along(x), function(i) data_sig[[i]]+data_0[[i]])) 

dMf_reduce <- function(dMod.frame) dMod.frame %>% 
  select(-contains("_0")) %>% 
  select(-contains("_sig"))
```

```{r augment dMod.frames}
basic_hypotheses.frame <- basic_hypotheses.frame %>% 
  dMf_append_objfuns()
  
bicmet.frame <- bicmet.frame%>% 
  dMf_append_objfuns()

apapbicmet.frame <- apapbicmet.frame%>% 
  dMf_append_objfuns()
```


```{r test objfuns}
basic_hypotheses.frame %>% .$obj %>% walk(loadDLL)
bicmet.frame %>% .$obj %>% walk(loadDLL)
apapbicmet.frame %>% .$obj %>% walk(loadDLL)


# basic_hypotheses.frame %>% mutate(test = map(seq_along(x), function(i) {
#   return(obj[[i]](getParameters(obj[[i]]) %>% are_names_of(0)))})
#   ) %>% .$test

bicmet.frame %>% mutate(test = map(seq_along(x), function(i) obj_sig[[i]](getParameters(obj_sig[[i]]) %>% are_names_of(0)))) %>% .$test

apapbicmet.frame%>% dMf_reduce() %>%  mutate(test = map(seq_along(x), function(i) obj[[i]](getParameters(obj[[i]]) %>% are_names_of(0)))) %>% .$test



```


```{r}
save.image(tpaste0("workspace_with_dMod.frames.rda"))
```



# Fit with prior around pars_raw, srel = -1, s0 = -2
```{r, dependson="setup"}
load("2018_04_23_13_03_workspace_with_dMod.frames.rda")
apapbicmet.frame %>% .$obj %>% walk(loadDLL)
```

```{r fix errorpars}
s0 <- paste(c("S0"), c("CUM_REC_METC13", "DOB", "P_CO2F"), sep = "_")
srel <- paste(c("SREL"), c("CUM_REC_METC13", "DOB", "P_CO2F"), sep = "_")
trafo_sigma_set <- trafo_apapbicmet_sigma_NA %>% 
  insert("x~-1", x = srel) %>% 
  insert("x~-2", x = s0)

p_sig <- P(trafo_sigma_set, modelname = "p_apapbicmet_sigma_set", compile = F)
compile(p_sig, output = "p_apapbicmet_sigma_set")
```

```{r setup prior}
getParameters(p_sig)

myindices <- pars_raw %>% names %>% toupper() %>% {which(. %in% getParameters(p_sig))}

prior_mu <- log(pars_raw[myindices])
names(prior_mu) <- toupper(names(prior_mu))

```

```{r setup prior.frame}
prior.frame <- apapbicmet.frame
prior.frame[["hypothesis"]] <- "srel = -1,s0=-2, prior_sigma ="

prior.frame[["p_sig"]] <- list(p_sig)

prior.frame <- prior.frame %>% 
  mutate(data_0 = map(data_0, . %>% 
                        .[!((names(.) %>% str_detect("lbert")) & (names(.) %>% str_detect("caps")))] %>% 
                        .[!(names(.) %>% str_detect("Mohr"))])) %>% 
  mutate(prd_0 = map(seq_along(x), function(i) cfn(g[[i]], cfn(x[[i]],p_0[[i]]))),
         prd_sig = map(seq_along(x), function(i) cfn(g[[i]], cfn(x[[i]],p_sig[[i]])))) %>% 
  mutate(obj_0 = map(seq_along(x), function(i) normL2(data_0[[i]], prd_0[[i]])),
         obj_sig = map(seq_along(x), function(i) cf_normL2(data = data_sig[[i]], prd_sig[[i]], e = e[[i]]))) %>% 
  
  mutate(obj = map(seq_along(x), function(i) obj_sig[[i]]+obj_0[[i]])) %>% 
  mutate(prd = map(seq_along(x), function(i) prd_sig[[i]]+prd_0[[i]])) %>% 
  mutate(data= map(seq_along(x), function(i) data_sig[[i]]+data_0[[i]])) 
  

prior.frame <- rbind(prior.frame, prior.frame, prior.frame, prior.frame) %>% 
  mutate(obj_data = obj) %>% 
  mutate(constr = map(seq_along(x), function(i) {
    {constraintL2(prior_mu, sigma = 10^(i-4))}
  })) %>% 
  mutate(obj = map(seq_along(x), function(i) {
    obj_data[[i]]+constr[[i]]
  })) %>% 
  mutate(hypothesis = map_chr(1:4, function(i) paste0(hypothesis[i], 10^(i-4))))
prior.frame[["pars"]] <- map(1:4, function(i) c(prior_mu, offset_bic = -0.011))
```

```{r test objfn}
# prior.frame %>% mutate(test = map(seq_along(x), function(i) getParameters(obj[[i]]))) %>% .$test

# # prior.frame %>% mutate(test = map(seq_along(x), function(i) obj[[i]](getParameters(obj[[i]]) %>% are_names_of(0)))) %>% .$test
# prior.frame %>% mutate(test = map(seq_along(x), function(i)  obj[[i]](pars[[i]]))) %>% .$test %>% page
# 
# prior.frame %>% mutate(test = map(seq_along(x), function(i)  obj_data[[i]](pars[[i]]))) %>% .$test %>% page
# 
# prior.frame %>% mutate(test = map(seq_along(x), function(i)  constr[[i]](pars[[i]]))) %>% .$test %>% page

```

```{r start and retrieve fits}
# fit_with_prior <- runbg({
#   ncores <- detectFreeCores()
#   assign("ncores", ncores, pos = .GlobalEnv)
# 
#   prior.frame %>%
#     
#     mutate(fits = map(seq_along(x), function(i) {
#       assign("fit_obj", obj[[i]], pos = .GlobalEnv)
#       assign("fit_pars", pars[[i]], pos = .GlobalEnv)
#       assign("fit_studyname", paste0("fits", hypothesis[[i]]), pos = .GlobalEnv)
#       mstrust(objfun = fit_obj, center = fit_pars, studyname = fit_studyname,
#               sd = 3,
#               blather = F, cores = ncores, fits = 10*ncores)
#     }))
#   }, machine = paste0("knecht", 1:5), filename = paste0("tmp_",tpaste0("fit_with_prior")), input = "prior.frame")
# 
# saveRDS(fit_with_prior, tpaste0("fit_with_prior.rds"))
# fit_with_prior <- fit_with_prior$get()
# myfits <- fit_with_prior %>% map("fits") %>% .[c(1,2,3,5)] %>% transpose() %>% map(. %>% Reduce(c.parlist,.))
# prior.frame[["fits"]] <- myfits
# saveRDS(prior.frame, tpaste0("prior.frame.rds")) # "2018_04_02_22_37_prior.frame.rds"
# 
# prior.frame <- readRDS("2018_04_02_22_37_prior.frame.rds")
# ```
# 
# ```{r}
# prior.frame <- prior.frame %>% dMf_expand_fits() %>% dMf_append_plots()
# ```
# 
# ```{r}
# prior.frame$plot_value
# prior.frame$parframes %>% map(. %>% .[1:600]) %>% map(plotValues,tol = 10)
# ```
# 
# ```{r}
# prior.frame %>% dMf_append_plots(tol  = 10, name %in% names(observables_bic)&(condition %in% names(rbind(data_bic,data_bic_sigma_NA) %>% as.datalist))) %>% .$plot_combined
```

## Run profiles for the prior.frame

```{r start and retrieve profiles for prior.frame}
# profile_jobs_prior <- map(1:4, function(j) {
#   assign("myframe",  prior.frame[j,], pos = .GlobalEnv)
#   runbg({
#     ncores <- detectFreeCores()
#     assign("ncores", ncores, pos = .GlobalEnv)
#     
#     myframe %>%
#       mutate(profiles = map(seq_along(x), function(i) {
#         assign("fit_obj", obj[[i]], pos = .GlobalEnv)
#         assign("fit_pars", best_parvec[[i]], pos = .GlobalEnv)
#         
#         profile(obj = fit_obj, pars = fit_pars, whichPar = names(fit_pars), cores = ncores)
#       }))
#   }, machine = paste0("knecht", c(j)), filename = paste0("tmp_",tpaste0("profile_jobs_prior")), input = "myframe")
# })
# 
#  saveRDS(profile_jobs_prior, tpaste0("profile_jobs_prior.rds"))
# profile_jobs_prior <- readRDS("2018_04_02_23_22_profile_jobs_prior.rds")
# prior.frame <- profile_jobs_prior %>% map(. %>% {.$get()} %>% .[[1]]) %>% do.call(rbind,.)
# saveRDS(prior.frame %>% shrink_fits() %>% shrink_plots(), tpaste0("prior.frame_with_profiles.rds")) # "2018_04_06_13_50_prior.frame_with_profiles.rds"
# prior.frame_old <- readRDS("2018_04_06_13_50_prior.frame_with_profiles.rds")
```



Looking at the profiles, some of the parameters are really far off their original values, whereas many can be determined quite well from the data.

Prior were good guesses for
  KA_APAP, offset_bic

APAPD_HLM_CL, APAPD_KM_APAP, CO2FIX_HLM_CL, CYP1A2MET_CL, 
    CYP1A2MET_KM_MET, , KA_CO2C13, KA_METC13, KBO_FIXCO2, 
    KBO_MAXCO2, KBO_RELCO2, KLU_EXCO2, offset_bic

I think, data is contributing enough for the following parameters, so the prior is not needed for them anymore
  APAPD_HLM_CL, APAPD_KM_APAP, KA_APAP



```{r}
# prior.frame$obj[[1]] %>% getParameters() %>% map(as.name) %>% unlist %>% dput
```


```{r}
# prior.frame$profiles %>% 
#   plotProfile() + 
#   coord_cartesian(ylim = c(-2, 4))
```

No comment on the paths yet.
```{r}
# prior.frame$profiles %>% plotPaths(whichPar = "KBO_FIXCO2")
```

The plotCombined looks much better with weaker priors!
```{r}
# prior.frame$obj %>% walk(loadDLL)
# prior.frame %>% plotCombined.dMod.frame(hypothesis = 4)
# map(1:4, . %>% plotCombined.dMod.frame(prior.frame, hypothesis = .))
```


# Run one fit with weak prior
```{r, dependson="setup"}
# load("2018_03_31_02_21_workspace_with_dMod.frames.rda")
# 
# rbind(bicmet.frame, apapbicmet.frame) %>% .$obj %>% walk(loadDLL)
```


```{r setup prior.frame}
# prior.frame_weak <- apapbicmet.frame
# prior.frame_weak[["hypothesis"]] <- "srel = -1,s0=-2, prior_sigma ="
# 
# prior.frame_weak[["p_sig"]] <- list(p_sig)
# 
# prior.frame_weak <- prior.frame_weak %>% 
#   mutate(data_0 = map(data_0, . %>% 
#                         .[!((names(.) %>% str_detect("lbert")) & (names(.) %>% str_detect("caps")))] %>% 
#                         .[!(names(.) %>% str_detect("Mohr"))])) %>% 
#   mutate(prd_0 = map(seq_along(x), function(i) cfn(g[[i]], cfn(x[[i]],p_0[[i]]))),
#          prd_sig = map(seq_along(x), function(i) cfn(g[[i]], cfn(x[[i]],p_sig[[i]])))) %>% 
#   mutate(obj_0 = map(seq_along(x), function(i) normL2(data_0[[i]], prd_0[[i]])),
#          obj_sig = map(seq_along(x), function(i) cf_normL2(data = data_sig[[i]], prd_sig[[i]], e = e[[i]]))) %>% 
#   
#   mutate(obj = map(seq_along(x), function(i) obj_sig[[i]]+obj_0[[i]])) %>% 
#   mutate(prd = map(seq_along(x), function(i) prd_sig[[i]]+prd_0[[i]])) %>% 
#   mutate(data= map(seq_along(x), function(i) data_sig[[i]]+data_0[[i]])) 
#   
# 
# prior.frame_weak <- rbind(prior.frame_weak, prior.frame_weak) %>% 
#   mutate(obj_data = obj) %>% 
#   mutate(constr = map(seq_along(x), function(i) {
#     {constraintL2(prior_mu, sigma = i*5)}
#   })) %>% 
#   mutate(obj = map(seq_along(x), function(i) {
#     obj_data[[i]]+constr[[i]]
#   })) %>% 
#   mutate(hypothesis = map_chr(c(1:2), function(i) paste0(hypothesis[i], i*5)))
# prior.frame_weak[["pars"]] <- map(1:2, function(i) c(prior_mu, offset_bic = -0.011))
```

```{r fit and profiles weak prior}
# fit_with_weaker_prior <- runbg({
#   ncores <- detectFreeCores()
#   assign("ncores", ncores, pos = .GlobalEnv)
#   
#   prior.frame_weak %>% 
#   mutate(fits = map(seq_along(x), function(i) {
#     assign("fit_obj", obj[[i]], pos = .GlobalEnv)
#     assign("fit_pars", pars[[i]], pos = .GlobalEnv)
#     assign("fit_studyname", paste0("fits", hypothesis[[i]]), pos = .GlobalEnv)
#     mstrust(objfun = fit_obj, center = fit_pars, studyname = fit_studyname,
#             sd = 3,
#             blather = F, cores = ncores, fits = 10*ncores)
#   }))
# },  machine = c(paste0("knecht", 3:4), paste0("ruprecht",1:2)), input = "prior.frame_weak", filename = "2018_04_12_18_28_fit_with_weaker_prior_runbg")
# saveRDS(fit_with_weaker_prior, file = "2018_04_12_18_28_fit_with_weaker_prior.rds")
# fit_with_weaker_prior <- readRDS("2018_04_12_18_28_fit_with_weaker_prior.rds")
# fit_with_weaker_prior$check()
# wait_for_runbg(fit_with_weaker_prior)
# fit_with_weaker_prior_results <- fit_with_weaker_prior$get()
# saveRDS(fit_with_weaker_prior_results, file = "2018_04_12_18_28_fit_with_weaker_prior_results.rds")
# fit_with_weaker_prior$purge()


# fit_with_weaker_prior <- readRDS("2018_04_12_18_28_fit_with_weaker_prior_results.rds")
# ```
# 
# ```{r}
# myfits <-
#   map(fit_with_weaker_prior, "fits") %>% 
#   transpose() %>% 
#   map(. %>% Reduce(c.parlist,.)) 
# prior.frame_weak <- fit_with_weaker_prior[[1]]
# prior.frame_weak$fits <- myfits
# ```
# 
# 
# ```{r}
# prior.frame_weak$obj %>% walk(loadDLL)
# prior.frame_weak <- prior.frame_weak %>% dMf_expand_fits() #%>% dMf_append_plots(index = 1:400)
# 
# prior.frame$obj %>% walk(loadDLL)
# prior.frame$prd <- map(1:4, function(i) prior.frame_weak$prd[[1]])
# prior.frame <- prior.frame %>% dMf_expand_fits() %>% dMf_append_plots()
# 
# ```
# 
# Seems as if there are some decent steps this time
# ```{r}
# prior.frame$plot_value
# prior.frame_weak %>% str1
# ```
# 

# ## profiles with weak prior
# ```{r}
# profiles_weak_prior_job <- runbg({
#     ncores <- detectFreeCores()
#     assign("ncores", ncores, pos = .GlobalEnv)
#   
#   prior.frame_weak %>%
#     mutate(profiles = map(seq_along(x), function(i) {
#       assign("fit_obj", obj[[i]], pos = .GlobalEnv)
#       assign("fit_pars", best_parvec[[i]], pos = .GlobalEnv)
#       
#       profile(obj = fit_obj, pars = fit_pars, whichPar = names(fit_pars), cores = ncores)
#     }))
# },  machine = c(paste0("ruprecht", 1)), input = "prior.frame_weak", filename = "2018_04_13_12_56_profiles_weak_prior_job_runbg")
# saveRDS(profiles_weak_prior_job, file = "2018_04_13_12_56_profiles_weak_prior_job.rds")
# profiles_weak_prior_job <- readRDS("2018_04_13_12_56_profiles_weak_prior_job.rds")
# profiles_weak_prior_job$check()
# wait_for_runbg(profiles_weak_prior_job, delta_t = 60)
# beepr::beep()
# profiles_weak_prior_job_results <- profiles_weak_prior_job$get()
# saveRDS(profiles_weak_prior_job_results, file = "2018_04_13_12_56_profiles_weak_prior_job_results.rds")
# profiles_weak_prior_job$purge()
# prior.frame_weak_old <- readRDS("2018_04_13_12_56_profiles_weak_prior_job_results.rds")$ruprecht1
```



# Reconcile fit results with new .c-files
I had the trouble that there was a random string attached to the function names in the .c-files, so when I let the script run again, these changed and the saved objects couldn't find their functions anymore in the DLLs. This is now fixed
```{r}
# prior.frame <- prior.frame %>% 
#   add_column(parframes = prior.frame_old$parframes,
#              profiles = prior.frame_old$profiles)
# 
# prior.frame_weak <- prior.frame_weak %>% 
#   add_column(parframes = prior.frame_weak_old$parframes,
#     profiles = prior.frame_weak_old$profiles)

# saveRDS(rbind(prior.frame, prior.frame_weak), file = tpaste0("prior.frame_full.rds"))
# prior.frame <- readRDS("2018_04_23_13_36_prior.frame_full.rds")

```


# Look at results
```{r}
prior.frame <- readRDS("2018_04_23_13_36_prior.frame_full.rds")
prior.frame$obj %>% walk(loadDLL)
```



The profiles of the weak fits are really bad and again slip into the trap with CYP1A2MET_KM_MET going to zero.
```{r}
prior.frame %>% plotProfile(1) +
  # coord_cartesian(ylim = c(-2, 4)) + 
  # scale_color_brewer() +
  geom_blank()
# ggplotly()
```

```{r}
prior.frame %>% dMf_expand_fits() %>% {.$parframes <- map(.$parframes, . %>% .[1:400]);.} %>%  dMf_append_plots() %>% .$plot_value
```



# combine prior.frame and prior.frame_weak

Next plan is to analyze the prior.frames at their respective optimum.

Qeustion: Which conditions push the parameter CYP1A2MET_KM_MET to -Inf?
```{r}

```

