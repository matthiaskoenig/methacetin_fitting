---
title: "Fitting model 39"
output: 
  html_document:
    toc: TRUE
---

Load all important libraries
```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=FALSE}
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(fig.width = 15)
library(dMod)
library(stringr) # Um bequem mit strings zu arbeiten
library(tidyverse) # Viele Funktionen, u.a. für data.frames und ggplot2 für schöne plots
library(magrittr) # der Pipe-operator %>%: z.B: x =" a; y="f(x); z="g(y); wird zu z=" a %>% f %>% g
library(conveniencefunctions)

merge_col2_into_col1 <- function(.data, col1, col2) {
  
  c1 <- enquo(col1)
  c2 <- enquo(col2)
  
  c1name <- quo_name(c1)
  c2name <- quo_name(c1)
  
  UQ <- rlang::UQ

  mutate(.data, UQ(c1name) := replace(UQ(c1), is.na(UQ(c1)), UQ(c2)[is.na(UQ(c1))])) %>% 
    select(-UQ(c2))
}

# load("workspace.rda")

```



# Read model
```{r}
source("../model/limax_pkpd_39.R")
```

```{r}
pars_raw <- c(x0, p) 
pars_in_dxdtdmod <- c(getSymbols(dxdt_dmod), names(dxdt_dmod))
```

# Odemodels and predicition function

## Apap
```{r odemodel_apap}
free_pars_apap <- c("Ka_apap", "APAPD_HLM_CL", "APAPD_Km_apap")
odemodel_apap <- odemodel(dxdt_dmod, modelname = "odemodel_apap", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_apap, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_apap <- Xs(odemodel_apap)
```


### Apap_doses
```{r odemodel_apap_doses}
free_pars_apap_doses <- c(free_pars_apap, "PODOSE_apap", "IVDOSE_apap")
odemodel_apap_doses <- odemodel(dxdt_dmod, modelname = "odemodel_apap_doses", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_apap_doses, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_apap_doses <- Xs(odemodel_apap_doses)
```

## Bicarbonate

```{r odemodel_bic}
free_pars_bic <- c("Ka_co2c13", "KLU_EXCO2", "CO2FIX_HLM_CL", "KBO_FIXCO2", "KBO_RELCO2", "KBO_MAXCO2")
odemodel_bic <- odemodel(dxdt_dmod, modelname = "odemodel_bic", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_bic, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_bic <- Xs(odemodel_bic)
```

## Metc13

```{r odemodel_met}
free_pars_met <- c("Ka_metc13", "CYP1A2MET_CL", "CYP1A2MET_Km_met")
odemodel_met <- odemodel(dxdt_dmod, modelname = "odemodel_met", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_met, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_met <- Xs(odemodel_met)
```

## Combined

```{r odemodel_apap_bic_met}
free_pars_apap_bic_met <- c(free_pars_apap_doses, free_pars_bic, free_pars_met) %>% unique
odemodel_apap_bic_met <- odemodel(dxdt_dmod, modelname = "odemodel_apap_bic_met", fixed = setdiff(pars_in_dxdtdmod, c(free_pars_apap_bic_met, "Aar_apap"))) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_apap_bic_met <- Xs(odemodel_apap_bic_met)
```


# Observation functions

## Apap, Apap_dose

```{r g_apap}
observables_apap <- y_dmod[c("Mve_apap", "DOB")] %>% set_names(c("apap", "dob_apap"))
g_apap <- Y(observables_apap, x_apap)
```

## Bicarbonate

```{r g_bic}
recovery_bic <- paste(y_dmod["Exhalation_co2c13"], "/ 60 *", y_dmod["Mre_co2c13"], "/ Ri_co2c13 * 100")
observables_bic <- c(recovery_bic, y_dmod[c("DOB", "P_CO2Fc13")])
names(observables_bic) <- c("recovery_bic", "dob_bic", "co2_ratio_bic")

g_bic <- Y(observables_bic, x_bic)
```

## Metc13

```{r g_met}
recovery_met <- paste(y_dmod["Exhalation_co2c13"], "/ PODOSE_metc13 * Mr_metc13 * 100" )
cum_met <- paste( dxdt_dmod["Abreath_co2c13"], "/ PODOSE_metc13 * Mr_metc13 * 100")
observables_met <- c(recovery_met, cum_met) %>% set_names(c("recovery_met", "cum_met"))

g_met <- Y(observables_met, x_met)
```

## Combined

```{r g_apap_bic_met}
observables <- c(observables_apap, observables_bic, observables_met)
g <- Y(observables_apap_bic_met, x_apap_bic_met)
```


# Data 
Read data and transform to dMod-format

## Apap 
```{r data_apap, message=FALSE}
files_apap <- file.path("../data/paracetamol/", list.files("../data/paracetamol/", pattern = ".csv", recursive = T))

data_apap <- lapply(files_apap, . %>% read_tsv) %>% do.call(dMod::combine,.)

data_apap <- data_apap %>% 
  mutate(apap_se = apap_sd/sqrt(n)) %>% 
  mutate(name = "apap") %>% 
  
  mutate(dose = replace(dose, is.na(dose), "")) %>% 
  mutate(route = replace(route, is.na(route), "")) %>% 
  mutate(application = replace(application, str_detect(application, "capsule"), "capsule"),
         application = replace(application, is.na(application), "")) %>% 
  
  select(study, application, route, dose, n, name, time, value = apap, sigma = apap_se) %>% # keep only necessary columns
  filter(!is.na(value)) %>% 

  fitErrorModel( factors = c("study", "application", "route", "dose"), plotting = F) %>% 
  select(-n) %>% 
  mutate(dose = as.numeric(dose))

doses_apap <- data.frame(unique(data_apap[c("study", "application", "route", "dose")])[-4] %>% as.list, 
                dose = c(650, 650, 1500,5600,1400,1000,1000,2000,500),
                dosepar = c(rep("PODOSE_apap", 5), "IVDOSE_apap", rep("PODOSE_apap", 3)),
                BW = c(68,68, 68,73,68,75,75,75,75), stringsAsFactors = F) 


data_apap <- rbind(left_join(data_apap %>% select(-dose), doses_apap) %>% filter(!str_detect(study, "Rawlins1977")), 
                   right_join(data_apap, doses_apap) %>% filter(!is.na(value))) %>% 
  select(-route) %>% 
  rename(group = application)

```

## Bicarbonate
```{r data_bic, message=FALSE}
files_bic <- file.path("../data/bicarbonate", list.files("../data/bicarbonate/", pattern = ".csv", recursive = T))

data_bic <- lapply(files_bic, function(filename) filename %>% read_tsv %>% mutate(study = filename)) %>% do.call(dMod::combine,.) # some had missing col "study", get the study col from the filename

data_bic <-
  data_bic %>% 
  mutate(study = str_replace_all(study, c("../data/bicarbonate/" = "", "\\.csv" = "", "_.*$" = ""))) %>% # clean the "study"-col
  
  mutate(time = replace(time, 
                        study %in% c("Barstow1990", "Irving1983", "Meineke1993"), 
                        time[study %in% c("Barstow1990", "Irving1983", "Meineke1993")]/60)) %>%  # Convert minutes into hours
  

  gather("name", "value", dob, co2_production, co2_ratio, recovery) %>% # convert to long format with cols value and sigma
  gather("name2", "sigma", dob_sd, co2_production_sd, recovery_sd) %>% 
  {df <- .;
  df2 <- df %>% mutate(name2 = "co2_ratio_sd", sigma = NA)
  rbind(df,df2)
  } %>% 
  mutate(name2 = str_replace(name2, "_sd", "")) %>% 
  filter(name == name2) %>% 
  filter(!(is.na(value)&is.na(sigma))) %>% 
  unique() %>% 
  
  select(-name2, -exercise, -period, -recovery_pm_sd, -trial) %>% # only keep necessary covariates
  
  mutate(sigma = sigma/sqrt(n)) %>% # convert sd to se
  select(-n) %>% 
  

  rename(group = label) %>% 
  
  filter(!(name %in% "co2_production")) %>% 
  
  mutate(name = paste0(name, "_bic")) %>% 

  {.}

doses_bic <-
  as.tibble(unique(data_bic[c("study","dose")])) %>% arrange(study, dose) %>% 
    cbind(dose2 = c(73, 0.79,46.5, 1.0, 12.5,25,50,100,16.54),
          dosepar = c("IVDOSE_co2c13", "Ri_co2c13", "IVDOSE_co2c13", "Ri_co2c13", rep("PODOSE_co2c13", 4), "IVDOSE_co2c13"), stringsAsFactors = F) %>% 
  select(-dose) %>% 
  rename(dose = dose2) %>% 
  mutate(BW = c(75,75,75,75,75,75,75,75, 81.3))


# insert doses into data_bic

studies_to_insert_doses <- data_bic$study[is.na(data_bic$dose)] %>% unique
for (i in studies_to_insert_doses) {
  data_bic$dose[data_bic$study == i] <- doses_bic$dose[doses_bic$study == i]
}

data_bic <- full_join(data_bic, doses_bic)
```

## Methacetin
```{r data_met, message=FALSE}
files_met <- file.path("../data/methacetin", list.files("../data/methacetin/", pattern = ".csv", recursive = T))

data_met <- lapply(files_met, function(filename) filename %>% read_tsv %>% mutate(study = filename)) %>% do.call(dMod::combine,.) # some had missing col "study", get the study col from the filename



data_met <-
data_met %>% 
  mutate(study = str_replace_all(study, c("../data/methacetin/" = "", "\\.csv" = "", "_.*$" = ""))) %>% # clean the "study"-col
  
  merge_col2_into_col1(group, intervention) %>% 
  merge_col2_into_col1(n, subjects) %>% 
  
  mutate(group = replace(group, !is.na(pid), pid[!is.na(pid)])) %>% # Affects Krumbiegel: Patient id can be identified by group, since both patients were healthy
  
  rename(dosing_strategy = dose) %>% 
  
  # group_by(study) %>% summarise(tmax = max(time)) # all of them appear to time given in minutes
  mutate(time = time/60) %>% 
  
  select(-recovery_pm_se, -recovery_sd, -cum_sd, -cum_pm_se, -pid) %>% # only keep necessary covariates/variables
  
  gather("name", "value", cum, recovery) %>%   # not the tidiest solution, but it works 
  gather("name2", "sigma", cum_se, recovery_se) %>% 
  mutate(name2 = str_replace(name2, "_se", "")) %>% 
  filter(name == name2) %>% 
  filter(!(is.na(value)&is.na(sigma))) %>% 
  unique() %>% 
    
  select(-name2, -n) %>% 
  
  mutate(name = paste0(name, "_met")) %>% 
  mutate(BW = 75) %>% 
  {.}

doses_met <-
  as.tibble(unique(data_met[c("study")])) %>% arrange(study) %>% 
  cbind(dose = c(75, 150,75,75,75,375,75),
        dosepar = c("PODOSE_metc13", "PODOSE_metc13", "PODOSE_metc13", "PODOSE_metc13", "PODOSE_metc13","PODOSE_metc13", "PODOSE_metc13"), stringsAsFactors = F) 

data_met <- full_join(data_met, doses_met)

```

## Combine data
```{r}
data <- dMod::combine(data_apap, data_bic, data_met) %>% replace_na(list(group = "", dosing_strategy = ""))
```



# Parameter trafos

```{r}
# save.image("workspace.rda")
```


## Apap
```{r p_apap}
data_apap <- filter(data, str_detect(dosepar, "apap"))

dosepars_apap <- data$dosepar %>% unique
outer_pars_apap <- sort(c(dosepars_apap, free_pars_apap))

trafo_apap <-
  pars_raw %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_apap), outer_pars_apap) %>% 
  
  branch(data_apap %>% as.datalist() %>% covariates()) %>% 
  
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% # insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars_apap) %>% 
  
  define("BW~bodyweight", bodyweight = BW) %>% # insert body weights
  
  insert("x~exp(X)", x = free_pars_apap, X = toupper(free_pars_apap)) # backtrafo to linear pars from log-pars

p_apap <- P(trafo_apap)

pars_apap <- log(pars_raw[free_pars_apap]) %>% set_names(toupper(free_pars_apap))
```

### Test plot
```{r plot_apap, eval=TRUE}
# loadDLL(x_apap)
times <- seq(0,24, 0.1)
plotCombined((g_apap*x_apap*p_apap)(times, pars_apap, deriv = F), data = data_apap %>% as.datalist(), name %in% names(observables_apap))
```

## Apap, study-specific aborption rates
```{r, warning=FALSE}
data_apap <- filter(data, str_detect(dosepar, "apap"))

dosepars_apap <- data$dosepar %>% unique
outer_pars_apap <- sort(c(dosepars_apap, free_pars_apap))

trafo_apap_free_ka <-
  pars_raw %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_apap), outer_pars_apap) %>% 
  
  branch(data_apap %>% as.datalist() %>% covariates()) %>% 
  
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% # insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars_apap) %>% 
  
  define("BW~bodyweight", bodyweight = BW) %>% # insert body weights
  
  insert("x~x_study_group", x = "Ka_apap", study = study, group = group) %>% 
  
  # insert("x~exp(X)", x = free_pars_apap, X = toupper(free_pars_apap)) 
  insert("x~exp(X)", 
         x = getSymbols(mytrafo[[i]]), 
         X = toupper(getSymbols(mytrafo[[i]])))  # hacking insert()...

p_apap_free_ka <- P(trafo_apap_free_ka)

pars_apap_free_ka <- getParameters(p_apap_free_ka) %>% are_names_of(0)
```


## Bicarbonate

### Error model
```{r e_bic}
data_bic <- data %>% filter(str_detect(dosepar, "co2c13"))

studies_with_sigma_na <- data_bic %>% filter(is.na(sigma)) %>% .[["study"]] %>% unique
data_bic_sigma_NA <- data_bic %>% filter(study %in% studies_with_sigma_na)
data_bic <- data_bic %>% filter(! study %in% studies_with_sigma_na)

errors_bic_sigma_NA <- paste0("s0_", names(observables_bic), " + srel_", names(observables_bic), " * ", names(observables_bic)) %>% set_names(names(observables_bic))

e_bic_sigma_NA <- Y(g = errors_bic_sigma_NA, f= (g_bic*x_bic))
```

### Parameter trafo
```{r p_bic}
dosepars_bic <- doses_bic$dosepar %>% unique
outer_pars_bic <- sort(c(dosepars_bic, free_pars_bic))

trafo_bic<-
  c(pars_raw) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_bic), outer_pars_bic) %>% 
  
  branch(data_bic %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% #insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars_bic) %>% 
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) 

p_bic <- P(trafo_bic)

pars_bic <- getParameters(p_bic) %>% are_names_of(0)
```

```{r p_bic_sigma_NA}
pars_errors_bic_sigma_NA <- getParameters(e_bic_sigma_NA) %>% are_names_of(1)

dosepars_bic <- doses_bic$dosepar %>% unique
outer_pars_bic <- sort(c(dosepars_bic, free_pars_bic, names(pars_errors_bic_sigma_NA)))

trafo_bic_sigma_NA <-
  c(pars_raw, pars_errors_bic_sigma_NA) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_bic), outer_pars_bic) %>% 
  
  branch(data_bic_sigma_NA %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% # insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars_bic) %>% 
  
  insert("s~s_study", s = names(pars_errors_bic_sigma_NA), study = study) %>% 
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) 

p_bic_sigma_NA <- P(trafo_bic_sigma_NA)

pars_bic_sigma_NA <- getParameters(p_bic_sigma_NA) %>% are_names_of(0)

# p_bic_sigma_NA(pars_bic_sigma_NA)
```

### Example plot
```{r}
loadDLL(x_bic)
(g_bic*x_bic*p_bic_sigma_NA)(times*10, pars_bic_sigma_NA, deriv = F) %>%  plotPrediction(name %in% names(observables_bic))
(g_bic*x_bic*p_bic)(times*10, pars_bic, deriv = F) %>%  
  # lapply(. %>% as.tibble)
  plotPrediction(name %in% names(observables_bic))

dosepars_bic
data_bic %>% 
  # filter(str_detect(name, "rec"))
  filter(study %>% str_detect("Lei"))
observables_bic
```


## Metc13
### Error model
```{r e_met}
data_met <- data %>% filter(str_detect(dosepar, "met"))

studies_with_sigma_na <- data_met %>% filter(is.na(sigma)) %>% .[["study"]] %>% unique
data_met_sigma_NA <- data_met %>% filter(study %in% studies_with_sigma_na)
data_met <- data_met %>% filter(! study %in% studies_with_sigma_na)

errors_met_sigma_NA <- paste0("s0_", names(observables_met), " + srel_", names(observables_met), " * ", names(observables_met)) %>% set_names(names(observables_met))

e_met_sigma_NA <- Y(g = errors_met_sigma_NA, f= (g_met*x_met))
```

### Parameter trafo
```{r p_met}
dosepars_met <- doses_met$dosepar %>% unique
outer_pars_met <- sort(c(dosepars_met, free_pars_met))

trafo_met<-
  c(pars_raw) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_met), outer_pars_met) %>% 
  
  branch(data_met %>% as.datalist() %>% covariates()) %>%  # The table of covariates includes dosepar and dose, which are used in the next line
  
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% #insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars_met) %>% 
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) 

p_met <- P(trafo_met)

pars_met <- getParameters(p_met) %>% are_names_of(0)
```


```{r p_met_sigma_NA}
pars_errors_met_sigma_NA <- getParameters(e_met_sigma_NA) %>% are_names_of(1)

dosepars_met <- doses_met$dosepar %>% unique
outer_pars_met <- sort(c(dosepars_met, free_pars_met, names(pars_errors_met_sigma_NA)))

trafo_met_sigma_NA <-
  c(pars_raw, pars_errors_met_sigma_NA) %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_met), outer_pars_met) %>% 
  
  branch(data_met_sigma_NA %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% # insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars_met) %>% 
  
  insert("s~s_study", s = names(pars_errors_met_sigma_NA), study = study) %>% 
  
  insert("x~exp(X)", x = getSymbols(mytrafo[[i]]), X = toupper(getSymbols(mytrafo[[i]]))) 

p_met_sigma_NA <- P(trafo_met_sigma_NA)

pars_met_sigma_NA <- getParameters(p_met_sigma_NA) %>% are_names_of(0)
```

### Example plot
```{r}
loadDLL(x_met)
(g_met*x_met*p_met_sigma_NA)(times*10, pars_met_sigma_NA, deriv = F) %>% plotPrediction(name %in% names(observables_met))
```



# Fit

## Objective functions

```{r objective functions}
obj_apap <- normL2(data_apap %>% as.datalist, (g_apap*x_apap*p_apap))
obj_apap_free_ka <- normL2(data_apap %>% as.datalist, (g_apap*x_apap*p_apap_free_ka))
obj_bic <- normL2(data_bic %>% as.datalist, (g_bic*x_bic*p_bic))
obj_bic_sigma_NA <- normL2(data_bic_sigma_NA %>% as.datalist, (g_bic*x_bic*p_bic_sigma_NA), errmodel = e_bic_sigma_NA)
obj_met <- normL2(data_met %>% as.datalist, (g_met*x_met*p_met))
obj_met_sigma_NA <- normL2(data_met_sigma_NA %>% as.datalist, (g_met*x_met*p_met_sigma_NA), errmodel = e_met_sigma_NA)
```

```{r testing the objfuns}
ls(pattern = "obj")[4] %>% lapply(function(i) {
  identifier <- str_replace(i, "obj_", "")
  paste0(i, "(pars_", identifier, ")") %>% parse(text=.) %>% eval()
})
```

Fit the objfuns without the data which doesn't contain sigmas
```{r fitting the objfuns}
# i <- ls(pattern = "obj")[1]
myjobs <- ls(pattern = "obj")[c(1,2,3,5)] %>% lapply(function(i) {
  identifier <- str_replace(i, "obj_", "")
  # paste0(i, "(pars_", identifier, ")")
  paste0("runbg(mstrust(", i, ",pars_", identifier, ",sd = 5, fits = 100, cores = 6), machine = 'ruprecht1')")  %>% parse(text=.) %>% eval()
})
```


```{r}
myjobs[[1]]$check()
```

## Include data without sigmas

```{r adding the respective objfuns together}
obj_met_all <- (obj_met + obj_met_sigma_NA)
obj_bic_all <- (obj_bic + obj_bic_sigma_NA)
```

```{r fitting the added objuns}
myjobs_all <- ls(pattern = "obj_(bic|met)_all") %>% lapply(function(i) {
  identifier <- str_replace_all(i, c("obj_" = "", "_all" = ""))
  # paste0(i, "(pars_", identifier, ")")
  paste0("runbg(mstrust(", i, ",pars_", identifier, ",sd = 5, fits = 100, cores = 5), machine = 'knecht1')")  %>% parse(text=.) %>% eval()
})
```



```{r}
# save.image(tpaste0("workspace.rda"))
```



# Analyse the fits!






```{r, eval=TRUE}
myfits_apap %>% as.parframe() %>% head(7)
```

### Plot the best fit
```{r, eval=TRUE}
myfits_apap %>% as.parframe() %>% as.parvec() %>% exp()

## Apap_
plotCombined((g*x_apap*p_apap)(times, myfits_apap %>% as.parframe() %>% as.parvec(), deriv = F), data = data_apap %>% as.datalist, name %in% c("apap")) + 
  ggtitle(paste("           -2LL =", myfits_apap %>% as.parframe() %>% .[1,"value"] %>% unlist %>% round(2)))
```

To me it looks as if the data of Albert1974 capsule is shifted to the right, since its rise starts later.
In the end this makes sense, because the capsule first needs to burst. The question is, how do we deal with this?


# Allow for different Aborption speeds

To me it looks as if the data of Albert1974 capsule is shifted to the right, since its rise starts later.
In the end this makes sense, because the capsule first needs to burst. The question is, how do we deal with this?

In a first step, let's assume all studies have a different absorption rate Ka_apap.


## Data
Read and transform to dMod-style
```{r}
files <- file.path("../data/paracetamol", list.files("../data/paracetamol/", pattern = ".csv", recursive = T))

data_1 <- lapply(files, . %>% read_tsv) %>% do.call(dMod::combine,.)

data_1 <- data_1 %>% 
  mutate(apap_se = apap_sd/sqrt(n)) %>% 
  mutate(name = "apap") %>% 
  
  mutate(dose = replace(dose, is.na(dose), "")) %>%
  mutate(route = replace(route, is.na(route), "")) %>% 
  mutate(application = replace(application, str_detect(application, "capsule"), "capsule"),
         application = replace(application, is.na(application), "")) %>% 
  
  # unite("study", study, application, route, dose, sep = "") %>% 
  
  select(study, application, route, dose, n, name, time, value = apap, sigma = apap_se) %>% 
  filter(!is.na(value)) %>% 
  {.}

data_1 <- fitErrorModel(data_1, factors = c("study", "application", "route", "dose"), plotting = F)

plotData(as.datalist(data_1))


doses <- data.frame(unique(data_1[c("study", "application", "route", "dose")])[-4] %>% as.list, 
                dose = as.character(c(650, 650, 1500,5600,1400,1000,1000,2000,500)),
                dosepar = c(rep("PODOSE_apap", 5), "IVDOSE_apap", rep("PODOSE_apap", 3)),
                stringsAsFactors = F)


data_1

data_1 <-
  rbind(
  left_join(data_1 %>% select(-dose), doses) %>% filter(!str_detect(study, "Rawlins1977")), 
  right_join(data_1, doses) %>% filter(!is.na(value))
)
data_1 <-  data_1 %>% select(-n)

plotData(as.datalist(data_1))
```



## Prepare conditions
```{r}
covtable <- data_1 %>% as.datalist() %>% covariates()

dosepars <- doses$dosepar %>% unique

outer_pars <- sort(c(dosepars, free_pars_apap))


trafo <-
  pars_raw %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars), outer_pars) %>% 
  branch(covtable) %>% 
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% #insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars) %>% # replace the other dose_par by zero
  
  insert("x~x_study_application", x = "Ka_apap", study = study, application = application) %>% 
  
  # insert("x~exp(X)", x = free_pars_apap, X = toupper(free_pars_apap)) 
  insert("x~exp(X)", x = mytrafo[[i]][is.na(as.numeric(mytrafo[[i]]))], X = toupper(mytrafo[[i]][is.na(as.numeric(mytrafo[[i]]))]))  # hacking insert()...

## trafo %>% head(1)
p_1 <- P(trafo)



pars_1 <- getParameters(p_1) %>% are_names_of(0)


dxdt_dmod %>% .[str_detect(.,"Km_apap")]

```



## Fit
```{r}
obj_1 <- normL2(data_1 %>% as.datalist, (g*x_apap*p_1))

myfits_1 <- mstrust(obj_1, pars_1, "second_fits", result_path = "intermediate_results", sd = 5, fits = 20, cores = 4, blather = T)
```

Show which fits converged
```{r, eval=TRUE}
myfits_1 %>% as.parframe() %>% head(7)
```

### Plot the best fit
Making the Ka_apap parameters condition specific improves the fit.
```{r, eval=TRUE}
plotCombined((g*x_apap*p_1)(times, myfits_1 %>% as.parframe() %>% as.parvec(1), deriv = F), data = data_1 %>% as.datalist, name %in% c("apap")) + 
  ggtitle(paste("           -2LL =", myfits_1 %>% as.parframe() %>% .[1,"value"] %>% unlist %>% round(2)))
# plotly::ggplotly()
```


## Run a profile likelihood analysis
```{r}
profile_job <- runbg(profile(obj_1, myfits_1 %>% as.parframe() %>% as.parvec(), names(pars_1), cores = 20), machine = "knecht6")

profiles_1 <- profile_job$get()$knecht6
profile_job$purge()
```



```{r}

transform_profile_pars <- function(profiles_1, par_value_fun) {

  my_expr <- rlang::enquo(par_value_fun)
  
# quo(
  profiles_1 %>% 
    gather(key = "par", value = "par_value", 7:length(.)) %>%  
    # mutate(par_value = !!my_expr) %>%
    mutate(par_value = UQ(rlang::enquo(par_value_fun))) %>%
    spread(key = par, value = par_value) %>% 
    structure(class = c("parframe", "data.frame")) %>% 
    {.}
  
# )
  
  
}



transform_profile_pars(profiles_1, exp(par_value)) %>% plotProfile()
profiles_1 %>% plotProfile()
```


```{r}
prf1 %>% plotProfile()
```




# Allow for different doses

It seems as if the specified dosing is too low in many cases. Therefore, we should try to adjust the dosing. This might help to account for the different bodyweights, different absorption efficiencies, etc...


## Prediction function with sensitivites also for doses
```{r}
odemodel_apap_doses <- odemodel(dxdt_dmod, fixed = setdiff(pars_in_dxdtdmod, c(free_pars_apap, "Aar_apap", "PODOSE_apap", "IVDOSE_apap")), modelname = "odemodel_2") # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_apap_doses <- Xs(odemodel_apap_doses)
loadDLL(x_apap_doses)
```



## Data
Read and transform to dMod-style
```{r}
files <- file.path("../data", list.files("../data", pattern = ".csv", recursive = T))

data_2 <- lapply(files, . %>% read_tsv) %>% do.call(dMod::combine,.)

data_2 <- data_2 %>% 
  mutate(apap_se = apap_sd/sqrt(n)) %>% 
  mutate(name = "apap") %>% 
  
  mutate(dose = replace(dose, is.na(dose), "")) %>%
  mutate(route = replace(route, is.na(route), "")) %>% 
  mutate(application = replace(application, str_detect(application, "capsule"), "capsule"),
         application = replace(application, is.na(application), "")) %>% 
  
  # unite("study", study, application, route, dose, sep = "") %>% 
  
  select(study, application, route, dose, n, name, time, value = apap, sigma = apap_se) %>% 
  filter(!is.na(value)) %>% 
  {.}

data_2 <- fitErrorModel(data_2, factors = c("study", "application", "route", "dose"), plotting = F)

plotData(as.datalist(data_2))


doses <- data.frame(unique(data_2[c("study", "application", "route", "dose")])[-4] %>% as.list, 
                dose = as.character(c(650, 650, 1500,5600,1400,1000,1000,2000,500)),
                dosepar = c(rep("PODOSE_apap", 5), "IVDOSE_apap", rep("PODOSE_apap", 3)),
                stringsAsFactors = F)


data_2

data_2 <-
  rbind(
  left_join(data_2 %>% select(-dose), doses) %>% filter(!str_detect(study, "Rawlins1977")), 
  right_join(data_2, doses) %>% filter(!is.na(value))
)
data_2 <-  data_2 %>% select(-n)

plotData(as.datalist(data_2))
```


## Prepare conditions
```{r, warning=FALSE}
covtable <- data_2 %>% as.datalist() %>% covariates()

dosepars <- doses$dosepar %>% unique

outer_pars <- sort(c(dosepars, free_pars_apap))


trafo <-
  pars_raw %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars), outer_pars) %>% 
  branch(covtable) %>% 
  define("dosepar~DOSE_study_dose", dosepar = dosepar, dose = dose, study = study) %>% #insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars) %>% # replace the other dose_par by zero
  
  insert("x~x_study_application", x = "Ka_apap", study = study, application = application) %>% 
  
  # insert("x~exp(X)", x = free_pars_apap, X = toupper(free_pars_apap)) 
  insert("x~exp(X)", x = mytrafo[[i]][is.na(as.numeric(mytrafo[[i]]))], X = toupper(mytrafo[[i]][is.na(as.numeric(mytrafo[[i]]))]))  # hacking insert()..., ignore the warnings, they're wanted :)

# trafo %>% head(1)
p_2 <- P(trafo)



pars_2 <- getParameters(p_2) %>% are_names_of(0)



```



## Fit
Fit with condition specific Ka_apap and Dosing

Apply a l2 prior on the dose.
```{r}
obj <- normL2(data_2 %>% as.datalist, (g*x_apap_doses*p_2))

pars_2[str_detect(names(pars_2), "DOSE")] <-  names(pars_2[str_detect(names(pars_2), "DOSE")]) %>% str_extract("\\d{3,4}$") %>% as.numeric() %>% log()

constraint <- constraintL2(pars_2[str_detect(names(pars_2), "DOSE")], sigma = .5) # set L2 constraint on the dose_parameters

# myfits_2 <- runbg({mstrust((obj+constraint), pars_2, "third_fits", result_path = "third_fits", sd = 3, fits = 96, cores = detectFreeCores(), blather = T)}, machine = "knecht6")
```


```{r, eval=TRUE}
myfits_2 %>% as.parframe() %>% head(7)

```




### Plot des erstbesten Fits
Zuerst die Parameter
```{r, eval=TRUE}
myfits_2 %>% as.parframe() %>% as.parvec() %>% exp
```

```{r, eval=TRUE}
plotCombined((g*x_apap_doses*p_2)(times, myfits_2 %>% as.parframe() %>% as.parvec(1), deriv = F), data = data_2 %>% as.datalist, name %in% c("apap"))+ 
  ggtitle(paste("           -2LL =", myfits_2 %>% as.parframe() %>% .[1,"value"] %>% unlist %>% round(2)))
## plotly::ggplotly()
```


### Plot des zweitbesten Fits
Unterschied in Baraka 1990

```{r, eval=TRUE}
myfits_2 %>% as.parframe(5) %>% as.parvec() %>% exp
```

```{r, eval=TRUE}
plotCombined((g*x_apap_doses*p_2)(times, myfits_2 %>% as.parframe() %>% as.parvec(5), deriv = F), data = data_2 %>% as.datalist, name %in% c("apap"))+ 
  ggtitle(paste("           -2LL =", myfits_1 %>% as.parframe() %>% .[5,"value"] %>% unlist %>% round(2)))
## plotly::ggplotly()
```



```{r}
save.image(file = tpaste0("workspace.rda"))
```







