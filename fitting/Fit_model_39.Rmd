---
title: "Fitting model 39"
output: 
  html_document:
    toc: TRUE
---

Load all important libraries
```{r, message=FALSE, warning=FALSE, eval=TRUE, echo=FALSE}
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(fig.width = 15)
library(dMod)
library(stringr) # Um bequem mit strings zu arbeiten
library(tidyverse) # Viele Funktionen, u.a. für data.frames und ggplot2 für schöne plots
library(magrittr) # der Pipe-operator %>%: z.B: x =" a; y="f(x); z="g(y); wird zu z=" a %>% f %>% g
library(conveniencefunctions)
```

```{r load old workspace, eval=TRUE}
load("2018-03-01 16-10 workspace.rda")
```

# Read model
```{r}
source("../model/limax_pkpd_39.R")
```

```{r}
pars_raw <- c(x0, p) 
pars_in_dxdtdmod <- c(getSymbols(dxdt_dmod), names(dxdt_dmod))
```

# Odemodels and predicition function

## Apap
```{r odemodel_apap}
free_pars_apap <- c("Ka_apap", "APAPD_HLM_CL", "APAPD_Km_apap", "Aar_apap")
odemodel_apap <- odemodel(dxdt_dmod, modelname = "odemodel_apap", fixed = setdiff(pars_in_dxdtdmod, free_pars_apap)) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_apap <- Xs(odemodel_apap)
```

```{r odemodel_apap_doses}
free_pars_apap_doses <- c(free_pars_apap, "PODOSE_apap", "IVDOSE_apap")
odemodel_apap_doses <- odemodel(dxdt_dmod, modelname = "odemodel_apap_doses", fixed = setdiff(pars_in_dxdtdmod, free_pars_apap_doses)) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_apap_doses <- Xs(odemodel_apap_doses)
```

## Bicarbonate

```{r odemodel_bic}
free_pars_bic <- c("Ka_co2c13", "KLU_EXCO2", "CO2FIX_HLM_CL", "KBO_FIXCO2", "KBO_RELCO2", "KBO_MAXCO2", "Aar_apap")
odemodel_bic <- odemodel(dxdt_dmod, modelname = "odemodel_bic", fixed = setdiff(pars_in_dxdtdmod, free_pars_bic)) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_bic <- Xs(odemodel_bic)
```

## Metc13

```{r odemodel_met}
free_pars_met <- c("Ka_metc13", "CYP1A2MET_CL", "CYP1A2Met_Km_met", "Aar_apap")
odemodel_met <- odemodel(dxdt_dmod, modelname = "odemodel_met", fixed = setdiff(pars_in_dxdtdmod, free_pars_met)) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_met <- Xs(odemodel_met)
```

## Combined

```{r odemodel_apap_bic_met}
free_pars_apap_bic_met <- c(free_pars_apap_doses, free_pars_bic, free_pars_met) %>% unique
odemodel_apap_bic_met <- odemodel(dxdt_dmod, modelname = "odemodel_apap_bic_met", fixed = setdiff(pars_in_dxdtdmod, free_pars_apap_bic_met)) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_apap_bic_met <- Xs(odemodel_apap_bic_met)
```


# Observation functions

## Apap, Apap_dose

```{r g_apap}
observables_apap <- y_dmod[c("Mve_apap", "DOB")] %>% set_names(c("apap", "dob_apap"))
g_apap <- Y(observables, x_apap)
```

## Bicarbonate

```{r g_bic}
recovery_bic <- paste(y_dmod["Exhalation_co2c13"], "/ 60 *", y_dmod["Mre_co2c13"], "/ Ri_co2c13 * 100")
observables_bic <- c(recovery_bic, y_dmod[c("DOB", "P_CO2Fc13")])
names(observables_bic) <- c("recovery_bic", "dob_bic", "co2_ratio_bic")

g_bic <- Y(observables_bic, x_bic)
```

## Metc13

```{r g_met}
recovery_met <- paste(y_dmod["Exhalation_co2c13"], "/ PODOSE_metc13 * Mr_metc13 * 100" )
cum_met <- paste( dxdt_dmod["Abreath_co2c13"], "/ PODOSE_metc13 * Mr_metc13 * 100")
observables_met <- c(recovery_met, cum_met) %>% set_names(c("recovery_met", "cum_met"))

g_met <- Y(observables_met, x_met)
```

## Combined

```{r g_apap_bic_met}
observables_apap_bic_met <- c(observables_apap, observables_bic, observables_met)
g_apap_bic_met <- Y(observables_apap_bic_met, x_apap_bic_met)
```


# Data and condition preparation
Read data and transform to dMod-style, generate the different conditions

## Apap 

### Read data
```{r}
files_apap <- file.path("../data/paracetamol/", list.files("../data/paracetamol/", pattern = ".csv", recursive = T))

data_apap <- lapply(files_apap, . %>% read_tsv) %>% do.call(dMod::combine,.)

data_apap <- data_apap %>% 
  mutate(apap_se = apap_sd/sqrt(n)) %>% 
  mutate(name = "apap") %>% 
  
  mutate(dose = replace(dose, is.na(dose), "")) %>% 
  mutate(route = replace(route, is.na(route), "")) %>% 
  mutate(application = replace(application, str_detect(application, "capsule"), "capsule"),
         application = replace(application, is.na(application), "")) %>% 
  
  unite("study", study, application, route, dose, sep = "") %>% 
  
  select(study, n, name, time, value = apap, sigma = apap_se) %>% 
  filter(!is.na(value)) %>% 
  {.}

data_apap <- fitErrorModel(data_apap, factors = c("study"), plotting = F)

doses_apap <- tibble(study =  unique(data_apap$study), 
                dose = c(650, 650, 1500,5600,1400,1000,1000,2000,500),
                dosepar = c(rep("PODOSE_apap", 5), "IVDOSE_apap", rep("PODOSE_apap", 3)))


data_apap <- full_join(data_apap, doses_apap)
data_apap <-  data_apap %>% select(-n)
```


### Prepare conditions
```{r}
dosepars_apap <- doses$dosepar %>% unique
outer_pars_apap <- sort(c(dosepars_apap, free_pars_apap))

trafo_apap <-
  pars_raw %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_apap), outer_pars_apap) %>% 
  branch(data_apap %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% #insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars_apap) %>% 
  insert("x~exp(X)", x = free_pars_apap, X = toupper(free_pars_apap)) 

p_apap <- P(trafo_apap)

pars_apap <- log(pars_raw[free_pars_apap]) %>% set_names(toupper(free_pars_apap))
```

### Plot
```{r, eval=TRUE}
times <- seq(0,24, 0.1)
plotCombined((g_apap*x_apap*p_apap)(times, pars_apap, deriv = F), data = data_apap %>% as.datalist, name %in% names(observables))
```


## Bicarbonate

### Read Data
```{r}
files_bic <- file.path("../data/bicarbonate", list.files("../data/bicarbonate/", pattern = ".csv", recursive = T))

data_bic <- lapply(files_bic, function(filename) filename %>% read_tsv %>% mutate(study = filename)) %>% do.call(dMod::combine,.) # some had missing col "study", get the study col from the filename

data_bic <- data_bic %>% 
  mutate(study = str_replace_all(study, c("../data/bicarbonate/" = "", "\\.csv" = "", "_.*$" = ""))) %>% # clean the "study"-col
  
  mutate(time = replace(time, 
                        study %in% c("Barstow1990", "Irving1983", "Meineke1993"), 
                        time[study %in% c("Barstow1990", "Irving1983", "Meineke1993")]/60)) %>%  # Convert minutes into hours
  
  gather("name", "value", dob, co2_production, co2_ratio, recovery) %>% 
  gather("name2", "sigma", dob_sd, co2_production_sd, recovery_sd) %>% 
  {df <- .;
  df2 <- df %>% mutate(name2 = "co2_ratio_sd", sigma = NA)
  rbind(df,df2)
  } %>% 
  mutate(name2 = str_replace(name2, "_sd", "")) %>% 
  filter(name == name2) %>% 
  filter(!(is.na(value)&is.na(sigma))) %>% 
  unique() %>% 
  
  select(-name2, -exercise, -period, -recovery_pm_sd) %>% # only keep necessary covariates
  
  mutate(sigma = sigma/sqrt(n)) %>% # convert sd to se
  select(-n) %>% 
  
  # arrange(trial, dose) %>% 
  # mutate(wup = paste(trial,dose)) %>% 
  # ggplot(aes(time,value, group = study, color = wup))+geom_path() + facet_wrap(~name, scales = "free_y") # seems as if trial can also be dropped
  select(-trial) %>% 
  
  filter(!(name %in% "co2_production")) %>% 
  
  mutate(name = paste0(name, "_bic")) %>% 

  {.}

doses_bic <-
  as.tibble(unique(data_bic[c("study","dose")])) %>% arrange(study, dose) %>% 
    cbind(dose2 = c(73, 0.79,46.5, 1.0, 12.5,25,50,100,16.54),
          dosepar = c("IVDOSE_co2c13", "Ri_co2c13", "IVDOSE_co2c13", "Ri_co2c13", rep("PODOSE_co2c13", 4), "IVDOSE_co2c13")) %>% 
  select(-dose) %>% 
  rename(dose = dose2)


# NEXT: insert doses into data_bic
left_join(doses_bic, data_bic)

```



### Prepare conditions
```{r}
dosepars_bic <- doses$dosepar %>% unique
outer_pars_bic <- sort(c(dosepars_bic, free_pars_bic))

trafo_bic <-
  pars_raw %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars_bic), outer_pars_bic) %>% 
  branch(data_bic %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% #insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars_bic) %>% 
  insert("x~exp(X)", x = free_pars_bic, X = toupper(free_pars_bic)) 

p_bic <- P(trafo_bic)

pars_bic <- log(pars_raw[free_pars_bic]) %>% set_names(toupper(free_pars_bic))
```







## Fit
```{r}
obj_apap <- normL2(data_apap %>% as.datalist, (g*x_apap*p_apap))

# obj_apap(pars_apap)

myfits_apap <- mstrust(obj_apap, pars, "first_fits", result_path = "intermediate_results", sd = 5, fits = 20, cores = 3, blather = T)
```



```{r, eval=TRUE}
myfits_apap %>% as.parframe() %>% head(7)
```

### Plot the best fit
```{r, eval=TRUE}
myfits_apap %>% as.parframe() %>% as.parvec() %>% exp()
plotCombined((g*x_apap*p_apap)(times, myfits_apap %>% as.parframe() %>% as.parvec(), deriv = F), data = data_apap %>% as.datalist, name %in% c("apap")) + 
  ggtitle(paste("           -2LL =", myfits_apap %>% as.parframe() %>% .[1,"value"] %>% unlist %>% round(2)))
```

To me it looks as if the data of Albert1974 capsule is shifted to the right, since its rise starts later.
In the end this makes sense, because the capsule first needs to burst. The question is, how do we deal with this?


# Allow for different Aborption speeds

To me it looks as if the data of Albert1974 capsule is shifted to the right, since its rise starts later.
In the end this makes sense, because the capsule first needs to burst. The question is, how do we deal with this?

In a first step, let's assume all studies have a different absorption rate Ka_apap.


## Data
Read and transform to dMod-style
```{r}
files <- file.path("../data", list.files("../data", pattern = ".csv", recursive = T))

data_1 <- lapply(files, . %>% read_tsv) %>% do.call(dMod::combine,.)htop

data_1 <- data_1 %>% 
  mutate(apap_se = apap_sd/sqrt(n)) %>% 
  mutate(name = "apap") %>% 
  
  mutate(dose = replace(dose, is.na(dose), "")) %>%
  mutate(route = replace(route, is.na(route), "")) %>% 
  mutate(application = replace(application, str_detect(application, "capsule"), "capsule"),
         application = replace(application, is.na(application), "")) %>% 
  
  # unite("study", study, application, route, dose, sep = "") %>% 
  
  select(study, application, route, dose, n, name, time, value = apap, sigma = apap_se) %>% 
  filter(!is.na(value)) %>% 
  {.}

data_1 <- fitErrorModel(data_1, factors = c("study", "application", "route", "dose"), plotting = F)

plotData(as.datalist(data_1))


doses <- data.frame(unique(data_1[c("study", "application", "route", "dose")])[-4] %>% as.list, 
                dose = as.character(c(650, 650, 1500,5600,1400,1000,1000,2000,500)),
                dosepar = c(rep("PODOSE_apap", 5), "IVDOSE_apap", rep("PODOSE_apap", 3)),
                stringsAsFactors = F)


data_1

data_1 <-
  rbind(
  left_join(data_1 %>% select(-dose), doses) %>% filter(!str_detect(study, "Rawlins1977")), 
  right_join(data_1, doses) %>% filter(!is.na(value))
)
data_1 <-  data_1 %>% select(-n)

plotData(as.datalist(data_1))
```



## Prepare conditions
```{r}
covtable <- data_1 %>% as.datalist() %>% covariates()

dosepars <- doses$dosepar %>% unique

outer_pars <- sort(c(dosepars, free_pars_apap))


trafo <-
  pars_raw %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars), outer_pars) %>% 
  branch(covtable) %>% 
  define("dosepar~dose", dosepar = dosepar, dose = dose) %>% #insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars) %>% # replace the other dose_par by zero
  
  insert("x~x_study_application", x = "Ka_apap", study = study, application = application) %>% 
  
  # insert("x~exp(X)", x = free_pars_apap, X = toupper(free_pars_apap)) 
  insert("x~exp(X)", x = mytrafo[[i]][is.na(as.numeric(mytrafo[[i]]))], X = toupper(mytrafo[[i]][is.na(as.numeric(mytrafo[[i]]))]))  # hacking insert()...

## trafo %>% head(1)
p_1 <- P(trafo)



pars_1 <- getParameters(p_1) %>% are_names_of(0)


dxdt_dmod %>% .[str_detect(.,"Km_apap")]

```



## Fit
```{r}
obj_1 <- normL2(data_1 %>% as.datalist, (g*x_apap*p_1))

myfits_1 <- mstrust(obj_1, pars_1, "second_fits", result_path = "intermediate_results", sd = 5, fits = 20, cores = 4, blather = T)
```

Show which fits converged
```{r, eval=TRUE}
myfits_1 %>% as.parframe() %>% head(7)
```

### Plot the best fit
Making the Ka_apap parameters condition specific improves the fit.
```{r, eval=TRUE}
plotCombined((g*x_apap*p_1)(times, myfits_1 %>% as.parframe() %>% as.parvec(1), deriv = F), data = data_1 %>% as.datalist, name %in% c("apap")) + 
  ggtitle(paste("           -2LL =", myfits_1 %>% as.parframe() %>% .[1,"value"] %>% unlist %>% round(2)))
# plotly::ggplotly()
```


## Run a profile likelihood analysis
```{r}
profile_job <- runbg(profile(obj_1, myfits_1 %>% as.parframe() %>% as.parvec(), names(pars_1), cores = 20), machine = "knecht6")

profiles_1 <- profile_job$get()$knecht6
profile_job$purge()
```



```{r}

transform_profile_pars <- function(profiles_1, par_value_fun) {

  my_expr <- rlang::enquo(par_value_fun)
  
# quo(
  profiles_1 %>% 
    gather(key = "par", value = "par_value", 7:length(.)) %>%  
    # mutate(par_value = !!my_expr) %>%
    mutate(par_value = UQ(rlang::enquo(par_value_fun))) %>%
    spread(key = par, value = par_value) %>% 
    structure(class = c("parframe", "data.frame")) %>% 
    {.}
  
# )
  
  
}



transform_profile_pars(profiles_1, exp(par_value)) %>% plotProfile()
profiles_1 %>% plotProfile()
```


```{r}
prf1 %>% plotProfile()
```




# Allow for different doses

It seems as if the specified dosing is too low in many cases. Therefore, we should try to adjust the dosing. This might help to account for the different bodyweights, different absorption efficiencies, etc...


## Prediction function with sensitivites also for doses
```{r}
odemodel_apap_doses <- odemodel(dxdt_dmod, fixed = setdiff(pars_in_dxdtdmod, c(free_pars_apap, "Aar_apap", "PODOSE_apap", "IVDOSE_apap")), modelname = "odemodel_2") # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.

x_apap_doses <- Xs(odemodel_apap_doses)
loadDLL(x_apap_doses)
```



## Data
Read and transform to dMod-style
```{r}
files <- file.path("../data", list.files("../data", pattern = ".csv", recursive = T))

data_2 <- lapply(files, . %>% read_tsv) %>% do.call(dMod::combine,.)

data_2 <- data_2 %>% 
  mutate(apap_se = apap_sd/sqrt(n)) %>% 
  mutate(name = "apap") %>% 
  
  mutate(dose = replace(dose, is.na(dose), "")) %>%
  mutate(route = replace(route, is.na(route), "")) %>% 
  mutate(application = replace(application, str_detect(application, "capsule"), "capsule"),
         application = replace(application, is.na(application), "")) %>% 
  
  # unite("study", study, application, route, dose, sep = "") %>% 
  
  select(study, application, route, dose, n, name, time, value = apap, sigma = apap_se) %>% 
  filter(!is.na(value)) %>% 
  {.}

data_2 <- fitErrorModel(data_2, factors = c("study", "application", "route", "dose"), plotting = F)

plotData(as.datalist(data_2))


doses <- data.frame(unique(data_2[c("study", "application", "route", "dose")])[-4] %>% as.list, 
                dose = as.character(c(650, 650, 1500,5600,1400,1000,1000,2000,500)),
                dosepar = c(rep("PODOSE_apap", 5), "IVDOSE_apap", rep("PODOSE_apap", 3)),
                stringsAsFactors = F)


data_2

data_2 <-
  rbind(
  left_join(data_2 %>% select(-dose), doses) %>% filter(!str_detect(study, "Rawlins1977")), 
  right_join(data_2, doses) %>% filter(!is.na(value))
)
data_2 <-  data_2 %>% select(-n)

plotData(as.datalist(data_2))
```


## Prepare conditions
```{r, warning=FALSE}
covtable <- data_2 %>% as.datalist() %>% covariates()

dosepars <- doses$dosepar %>% unique

outer_pars <- sort(c(dosepars, free_pars_apap))


trafo <-
  pars_raw %>% 
  sort_by_name() %>% 
  replace((names(.) %in% outer_pars), outer_pars) %>% 
  branch(covtable) %>% 
  define("dosepar~DOSE_study_dose", dosepar = dosepar, dose = dose, study = study) %>% #insert values for the doses
  insert("remainingdosepar~0", remainingdosepar = dosepars) %>% # replace the other dose_par by zero
  
  insert("x~x_study_application", x = "Ka_apap", study = study, application = application) %>% 
  
  # insert("x~exp(X)", x = free_pars_apap, X = toupper(free_pars_apap)) 
  insert("x~exp(X)", x = mytrafo[[i]][is.na(as.numeric(mytrafo[[i]]))], X = toupper(mytrafo[[i]][is.na(as.numeric(mytrafo[[i]]))]))  # hacking insert()..., ignore the warnings, they're wanted :)

# trafo %>% head(1)
p_2 <- P(trafo)



pars_2 <- getParameters(p_2) %>% are_names_of(0)



```



## Fit
Fit with condition specific Ka_apap and Dosing

Apply a l2 prior on the dose.
```{r}
obj <- normL2(data_2 %>% as.datalist, (g*x_apap_doses*p_2))

pars_2[str_detect(names(pars_2), "DOSE")] <-  names(pars_2[str_detect(names(pars_2), "DOSE")]) %>% str_extract("\\d{3,4}$") %>% as.numeric() %>% log()

constraint <- constraintL2(pars_2[str_detect(names(pars_2), "DOSE")], sigma = .5) # set L2 constraint on the dose_parameters

# myfits_2 <- runbg({mstrust((obj+constraint), pars_2, "third_fits", result_path = "third_fits", sd = 3, fits = 96, cores = detectFreeCores(), blather = T)}, machine = "knecht6")
```


```{r, eval=TRUE}
myfits_2 %>% as.parframe() %>% head(7)

```




### Plot des erstbesten Fits
Zuerst die Parameter
```{r, eval=TRUE}
myfits_2 %>% as.parframe() %>% as.parvec() %>% exp
```

```{r, eval=TRUE}
plotCombined((g*x_apap_doses*p_2)(times, myfits_2 %>% as.parframe() %>% as.parvec(1), deriv = F), data = data_2 %>% as.datalist, name %in% c("apap"))+ 
  ggtitle(paste("           -2LL =", myfits_2 %>% as.parframe() %>% .[1,"value"] %>% unlist %>% round(2)))
## plotly::ggplotly()
```


### Plot des zweitbesten Fits
Unterschied in Baraka 1990

```{r, eval=TRUE}
myfits_2 %>% as.parframe(5) %>% as.parvec() %>% exp
```

```{r, eval=TRUE}
plotCombined((g*x_apap_doses*p_2)(times, myfits_2 %>% as.parframe() %>% as.parvec(5), deriv = F), data = data_2 %>% as.datalist, name %in% c("apap"))+ 
  ggtitle(paste("           -2LL =", myfits_1 %>% as.parframe() %>% .[5,"value"] %>% unlist %>% round(2)))
## plotly::ggplotly()
```



```{r}
save.image(file = tpaste0("workspace.rda"))
```







