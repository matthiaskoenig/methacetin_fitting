%>% ---
title: "Fitting model 49"
output: 
  html_document:
    toc: TRUE
---


Load all important libraries
```{r setup, message=FALSE, warning=FALSE, eval=TRUE, echo=FALSE}
knitr::opts_chunk$set(eval = TRUE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(fig.width = 15)
# library(stringr) # Um bequem mit strings zu arbeiten
# library(tidyverse) # Viele Funktionen, u.a. für data.frames und ggplot2 für schöne plots
# library(magrittr) # der Pipe-operator %>%: z.B: x =" a; y="f(x); z="g(y); wird zu z=" a %>% f %>% g
library(conveniencefunctions)

# r modifications of plotting functions}
# stepDetect <- dMod:::stepDetect
# plotPars.parframe <- dMod:::plotPars.parframe
# getSteps <- function(myparframe, stepInd = 1, tol = 1) {
#   steps <- steps0 <- stepDetect(myparframe$value, tol)
#   steps0 <- c(steps0, nrow(myparframe))
# 
#   if(!is.null(stepInd)){
#     nsteps <- length(stepInd)
#     steps <- stepInd
#   } else {
#     steps <- steps[order(c(diff(steps), nrow(myparframe)-max(steps)), decreasing = T)][1:nsteps]
#     steps <- unique(sort(c(1, steps))) #include the first step no matter what
#     if(length(steps0) <= nsteps) 
#       nsteps <- length(steps0)
#   }
#   
#   steps <- c(steps, nrow(myparframe))
#   steps_indices <- which(steps0%in%steps)
#   
#   step_members <- lapply(1:nsteps, function(i) {
#     steps0[steps_indices[i]]:(steps0[steps_indices[i]+1]-1)
#   }) 
#   step_members <- do.call(c,step_members)
#   
#   myparframe[step_members,]
# }
# 
# 
# plotPars2 <- function(dMod.frame = model, hypothesis = 1:2,  ..., nsteps = 3, tol = 1, stepInd = NULL ) {
# 
#   if (!missing(...)) {dots <- substitute(...)
#   } else {
#     dots <- T
#   }
# 
#   if(is.character(hypothesis)) hypothesis <- which(dMod.frame$hypothesis == hypothesis)
# 
#   if(length(hypothesis)==1) {
#     myparframe <- dMod.frame[["parframes"]][[hypothesis]]
#     myparframe <- getSteps(myparframe, nsteps = nsteps, tol = tol, stepInd = stepInd)
# 
#     plotPars.parframe(myparframe, ..., tol = tol) +
#       ggtitle(label = paste0(dMod.frame[["hypothesis"]][[hypothesis]], "\n",
#                              "best value = ", round(dMod.frame[["parframes"]][[hypothesis]][1,"value", drop = T],1), "\n",
#                              paste0(paste(names(dots), "=", dots )[-1], collapse = "\n")) )
#   } else {
#     mydata <- do.call(rbind,lapply(hypothesis, function(hyp) {
#       pars <- dMod.frame[["parframes"]][[hyp]]
#       pars <- cbind(index = 1:nrow(pars), pars[order(pars$value),!(names(pars) == "index")])
#       if(!is.null(stepInd)){
#         steps <- stepInd
#       } else {
#         steps <- getStepIndices(pars, nsteps, tol)
#       }
#       pars <- getSteps(pars, tol = tol, stepInd = steps)
#       cbind(hypothesis = hyp, step = factor(findInterval(pars$index, steps), labels = steps), pars)
#     }))
#     mydata$hypothesis <- as.factor(mydata$hypothesis)
# 
#     myindices <- with(mydata, eval(dots))
#     mydata <- mydata[myindices,]
# 
#     mydata2 <- wide2long.data.frame(mydata[-c(4,5,6)], keep = 1:3)
#     mydata2$hyp_step <- paste(mydata2$hypothesis, mydata2$step, sep = "_")
# 
#     ggplot2::ggplot(mydata2, aes(x = name, y = value, color = hyp_step)) +
#       geom_boxplot(outlier.alpha = 0) +     # annotate("text", x = jumps + 1, y = y.jumps, label = jumps, hjust = 0, color = "red", size = 3) +
#       xlab("parameter") + ylab("value") + theme_dMod() +
#       theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
# 
#   }
# 
# }
```


# Read model
```{r read_model, dependson="setup"}
source("../../model/limax_pkpd_v49.R")
pars_raw <- c(x0, p) 
pars_in_dxdtdmod <- c(getSymbols(dxdt_dmod), names(dxdt_dmod))


pars_raw["APAPD_HLM_CL"] <- 2.20866840885261
pars_raw["Ka_apap"] <- 2.47235563004252
pars_raw["APAPD_Km_apap"] <- 0.347655392999114
```


# Data - read and preprocess
Read data, insert the default values for the parameters supplied in the data sheet. 

* Taheri rausschmeißen zum Fitten: Wird weiter unten getan

```{r, message=FALSE}
# Read data
data_full <-
  read_csv("../../data/limax_pkpd_v49_data.csv") %>%
  select(-model) %>% 
  rename(name = observer) %>% 
  rename(n = subjects) %>% 
  unique() #noch matthias sagen, dass lalazar2008 doppelte einträge hat

# For those studies where some data points have no sigma, infer it from the other sigmas of the same study
fitErrorModel_factors <- c("study", "group", "name", "BW", "PODOSE_apap", "IVDOSE_apap", 
"PODOSE_co2c13", "IVDOSE_co2c13", "Ri_co2c13", "ti_co2c13", "PODOSE_metc13", 
"IVDOSE_metc13", "ti_metc13")
some_na <-
  data_full %>% 
  group_by(study, group, name) %>% 
  mutate(nna = n(), sna = sum(is.na(sigma))) %>% 
  filter(sna>0 & sna != nna) %>% 
  select(-sna, -nna) %>% 
  as.data.frame() %>% 
  fitErrorModel(factors = fitErrorModel_factors, plotting = F, blather = F) 

none_or_all_na <- data_full %>% 
  group_by(study, group, name) %>% 
  mutate(nna = n(), sna = sum(is.na(sigma))) %>% 
  filter(sna==0 | sna == nna) %>% 
  select(-sna, -nna) %>% 
  as.data.frame()


data_full <- rbind(some_na, none_or_all_na) %>% 
  select(-n) 


# Roecker  
data_full <- data_full %>% 
  filter(time > 0)

# Don't fit APAP all the time
data_full <- data_full %>% 
  filter(simulation != "apap")

```

```{r}
# data_full %>% select(1:7) %>%
#   filter(str_detect(study, "^Ro|Irv")) %>%
#   mutate(sigma = 10 + value * 0.001) %>%
#   # mutate(value = log(value), sigma = )
#   as.data.frame() %>% as.datalist() %>%
#   plotData(
#     transform = "log10(value)"
#     ) +
# # coord_cartesian(ylim = c(000,500)) +
#   # coord_cartesian(ylim = c(1000,10000))+
# geom_blank()
```

```{r try to fit a transient function to Roecker}
# didn't work out

# transient_1 <- c("Asus*(1-exp(-time/tau1)) + Atrans*(1-exp(-time/tau1))*exp(-time/tau2)")
# transient_2 <- insert(transient_1, "x~x_2", x = .currentSymbols)
# 
# transientfun <- paste0(transient_1, " + ", transient_2)
# 
# xt <- Xt()
# mypars <- getSymbols(transientfun)[!"time" == getSymbols(transientfun)]
# gtrans <- Y(c(DOB = transientfun, t1 = transient_1, t2 = transient_2), parameters = mypars)
# etrans <- Y(c(DOB = "s0 + srel * DOB", "t1" = 0, "t2" = 0), gtrans)
# 
# data_roecker <- data_full %>% select(1:7) %>%
#   filter(str_detect(study, "^Ro")) %>%
#   filter(time > 0) %>% 
#   # mutate(sigma = 5 + value * 0.001) %>%
#   # mutate(value = log(value), sigma = )
#   as.data.frame() %>% as.datalist()
# 
# ptrans <- getParameters(gtrans,etrans) %>% 
#   setNames(.,.) %>% 
#   branch(data_roecker %>% covariates) %>% 
#   insert("x~exp(x)", x = .currentSymbols) %>% 
#   P
# 
# obj_roecker <- normL2(data_roecker, (gtrans*xt*ptrans), etrans)
# 
# 
# model <- dMod.frame(1, gtrans, xt, ptrans, data_roecker, etrans) %>% appendObj(time = list(seq(0,0.5, length.out = 2000)))
# 
# 
# 
# 
# fixed = c(s0 = 5, srel= 0.001)
# pars <- model$pars[[1]] %>% .[!names(.) %in% names(fixed)] %>% `*`(0)
# 
# model <- model %>% mutate(fits = list(mstrust(obj, pars, fits = 20, cores = 4, fixed = fixed))) %>% appendParframes()

```



# Set up the model

```{r setup model independently of the individual setups}
free_pars <- c("Kp_co2c13", "KBO_MAX_CO2", "KBO_REL_CO2", "KBO_FIX_CO2", "KLI_MAX_CO2", "KLI_REL_CO2", "KLI_FIX_CO2", "KLU_EX_CO2", "KLU_EXKM_CO2", "Ka_co2c13", "Ka_metc13")

# Observables

recovery_bic <- paste(y_dmod["Exhalation_co2c13"], "/ 60 * Mr_co2c13 / Ri_co2c13 * 100")
P_CO2F <- paste0(y_dmod["P_CO2Fc13"], "-", str_replace(y_dmod["P_CO2Fc13"], "Alu_co2c13", "0")) # Alu_co2c13 is the only dynamic variable which goes into the equation and it's initial value is fixed to zero.
observables_bic <- c(cum_rec_co2c13 = recovery_bic, y_dmod[c("DOB")], P_CO2F = P_CO2F)

recovery_met <- paste(y_dmod["Exhalation_co2c13"], "/ init_PODOSE_metc13 * Mr_metc13 * 100" )
cum_met <- paste( "Abreath_co2c13/ init_PODOSE_metc13 * Mr_metc13 * 100")
observables_met <- c(recovery_met, cum_met) %>% set_names(c("mom_rec_metc13", "cum_rec_metc13"))

# Error models
errors_bic_sigma_NA <- paste0("sqrt(s0_", names(observables_bic), "^2 + srel_", names(observables_bic), "^2 * ", names(observables_bic), "^2 )") %>% set_names(names(observables_bic))
errors_bic_sigma_NA["cum_rec_co2c13"] <- 1 #hierfür gibts eh keine daten und ich weiß nicht, ob ich es einfach weglassen kann

errors_met_sigma_NA <- paste0("sqrt(s0_", names(observables_met), "^2 + srel_", names(observables_met), "^2 * ", names(observables_met), "^2)") %>% set_names(names(observables_met))
errors_met_sigma_NA["mom_rec_metc13"] <- 1 #hierfür gibts eh keine daten mit sigma=NA
```

```{r x g and e apapbicmet}
myodemodel <- odemodel(dxdt_dmod, fixed = setdiff(pars_in_dxdtdmod, c(free_pars, "Aar_apap")), modelname = "x", compile = F) # Aar_apap is not there to be optimized, but a variable which is a state is needed because of a bug in odemodel.
x <- Xs(myodemodel)
g <- Y(c(observables_bic, observables_met), x, attach.input = F, modelname = "g", compile = F)
e_sigma_NA <- Y(c(errors_bic_sigma_NA, errors_met_sigma_NA), g)#, modelname = "e", compile = F) #cant cope with NaNs passed to it, if compiled

compile(g,x, cores = 3, output = "gx")
```

```{r data and p apapbicmet}
# Remove certain studies from the data which goes into fitting
data_for_fitting <- data_full %>% 
  filter(!str_detect(simulation, "limax")) %>% 
  filter(!str_detect(study, "Mohr2018")) %>% 
  filter(!(str_detect(study, "Albert")&str_detect(group, "capsule")))

# Split the data in datasets with and without sigma
data <- data_for_fitting  %>% filter(!is.na(sigma)) %>% select(-simulation)
data_sigma_NA <- data_for_fitting  %>% filter(is.na(sigma)) %>% select(-simulation)

# Get all parameters that in some way replace pars_raw (parameters supplied by the SBML file) or are additional parameters that we need to fit
# This could be e.g. Study specific pars such as IVDOSE* or pars that are fitted
supplied_pars <- names(pars_raw)[(names(pars_raw) %in% names(data))]
outer_pars <- sort(unique(c(free_pars, supplied_pars)))

pars_errors <- c(errors_bic_sigma_NA, errors_met_sigma_NA) %>% 
  getSymbols %>% 
  str_subset("^s") %>% 
  are_names_of(1)
outer_pars_sigma_NA <- sort(unique(c(outer_pars, names(pars_errors))))

# Define the parameter trafos which in turn define the different conditions
trafo <-
  c(pars_raw) %>% 
  sort_by_name() %>% 
  replace(names(.) %in% outer_pars, outer_pars) %>% 
  
  branch(data %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line

insert("name ~ value", value = unlist(mget(supplied_pars)), name = supplied_pars) %>% # insert parameters supplied by the data

  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters
  
  insert("x~exp(x)", x = .currentSymbols) %>% 
  insert("x~y+r_x", y = c("KBO_FIX_CO2", "KBO_REL_CO2"), x = c("KLI_FIX_CO2", "KLI_REL_CO2")) %>% 

  {.}



trafo_sigma_NA <-
  c(pars_raw, pars_errors) %>% 
  sort_by_name() %>% 
  replace(names(.) %in% outer_pars_sigma_NA, outer_pars_sigma_NA) %>%
  
  branch(data_sigma_NA %>% as.datalist() %>% covariates()) %>% # The table of covariates includes dosepar and dose, which are used in the next line
  insert("name ~ value", value = unlist(mget(supplied_pars)), name = supplied_pars) %>%

  define("init_PODOSE_metc13~podose", podose = mytrafo[[i]]["PODOSE_metc13"]) %>% # For the observables, I need the initial dose as a fixed parameter which doesn't change. Because the PODOSE_metc13 is also a state, I need to duplicate this parameters
  
  insert("x~exp(x)", x = .currentSymbols) %>% 
  insert("x~y+r_x", y = c("KBO_FIX_CO2", "KBO_REL_CO2"), x = c("KLI_FIX_CO2", "KLI_REL_CO2")) %>% 
  
  # Fix some parameters, error bars were estimated by eye 
  insert("x~-11", x = str_subset(.currentSymbols, "^s0"), conditionMatch = "Meineke1993") %>% # Fix the error parameters to a value
  insert("x~0", x = str_subset(.currentSymbols, "^s0"), conditionMatch = "(Barstow)") %>% 
  insert("x~-5", x = str_subset(.currentSymbols, "^srel"), conditionMatch = "Barstow") %>% 
  insert("x~-3", x = str_subset(.currentSymbols, "^srel"), conditionMatch = "(Meineke)") %>% 
  
  insert("x~2.3", x = str_subset(.currentSymbols, "s0_DOB"), conditionMatch = "Roecker") %>% 
  insert("x~-5", x = str_subset(.currentSymbols, "srel_DOB"), conditionMatch = "Roecker") %>% 
  insert("x~0", x = str_subset(.currentSymbols, "s(0|rel)"), conditionMatch = "Roecker") %>% 

  
  insert("x~0", x = str_subset(.currentSymbols, "s((0)|(rel))_((DOB)|(P_CO2F))")) %>% 
  insert("x~-4", x = str_subset(.currentSymbols, "s((0)|(rel))"), conditionMatch = "Krumbiegel") %>% 
  
  {.}

```

```{r}

p <- P(trafo, modelname = "p", compile = F)
pars <- getParameters(p) %>% are_names_of(0)

p_sigma_NA <- P(trafo_sigma_NA, modelname = "p_sig", compile = F)
pars_sigma_NA <- getParameters(p_sigma_NA) %>% are_names_of(0)


compile(p, p_sigma_NA, cores = 3, output = "p")
remove_c_and_o()
```


```{r}
# save.image("workspace.rda")
# load("workspace.rda"); loadDLL(x)
```


# dMod.frame
```{r initialize dMod_frame}
model <- dMod.frame(
  hypothesis = "Model v49",
  x = x,
  g = g,
  p = p,
  data = data,
  e = NULL,
  x_sig = x,
  g_sig = g,
  p_sig = list(p_sigma_NA),
  e_sig = list(e_sigma_NA),
  data_sig = list(as.datalist(data_sigma_NA))
)

model <- model %>% 
  rowwise() %>% 
  appendObj() %>% 
  mutate(prd_sig = list(g_sig * x_sig * p_sig), 
         obj_data_sig = list(normL2(data_sig, prd_sig, e_sig)),
         pars = list(union(getParameters(p), getParameters(p_sig)) %>% are_names_of(rnorm)),
         obj = list(obj_data+ obj_data_sig),
         times = list(c(
           seq(0,1,length.out = 500),
           seq(min(rbind(as.data.frame(data),as.data.frame(data_sig))[["time"]]), 
                          max(rbind(as.data.frame(data),as.data.frame(data_sig))[["time"]]) * 1.1, 
                          length.out = 200)
           ))
         ) %>% 
  mutate(prd_data = list(prd),
         prd = list(prd_data+prd_sig), 
         data_data = list(data),
         data = list(data_data + data_sig),
         description = "Model v49")


# Iterative fitting: select only bic and apap first
studies_bic <-  data_full %>% filter(simulation %in% c("bicarbonate"))  %>% .[["study"]] %>% unique
studies_met <-  data_full %>% filter(simulation %in% c("methacetin"))  %>% .[["study"]] %>% unique
all_cond <- getConditions(model)
cond_bic <- map(all_cond, . %>% str_subset(studies_bic)) %>% do.call(c,.)
cond_met <- map(all_cond, . %>% str_subset(studies_met)) %>% do.call(c,.)

model <- model %>% 
  mutate(cond_bic = list(cond_bic),
         cond_met = list(cond_met))
```

```{r}
# saveRDS(model, "model0.rds")
# model <-  readDMod.frame("model0.rds")
```

```{r test model, eval=FALSE}
# hypothesis = 1
# test_dMod.frame <- function(model, hypothesis = 1, ...){
#   print(plotCombined(model,hypothesis))
#   print(with(unlist(model[hypothesis,], F), {
#     obj(times, pars = pars)
#   }))
# }
# test_dMod.frame(model,1)
remove(list = paste0("cond_", c("apap", "bic", "met")))
print(with(unlist(model[1,], F), {
    obj(times, pars = pars)
  }))
plotCombined(model,1,1,name%in%"DOB", str_detect(condition, "Irv|Bar|Roe"), time < 0.1)
model$pars[[1]] %>% `[<-`(., 1:length(.), -20) %>% sort_by_name() %>% .[-2] %>%   print_r.named_vector()
```

# Fit 
```{r}
fit_short_roecker_job <- runbg({
    ncores <- detectFreeCores()
    assign("ncores", ncores, pos = .GlobalEnv)

   out <- model %>%
    ungroup %>%
     mutate(fixed = list(c(
       Ka_metc13  = 6.0966305
       ))) %>% 
    mutate(fits = map(seq_along(x), function(i) {
      assign("fit_obj", obj[[i]], pos = .GlobalEnv)
      
      fit_fixed <- fixed[[i]]
      assign("fit_fixed", fit_fixed, pos = .GlobalEnv)
      
      fit_pars <- pars[[i]] * 0 
      fit_pars <- fit_pars[!names(fit_pars)%in%names(fit_fixed)]
      assign("fit_pars", fit_pars, pos = .GlobalEnv)
      
      fit_conditions = c(cond_bic[[i]])
      assign("fit_conditions", fit_conditions, pos = .GlobalEnv)
      assign("fit_studyname", paste0("fits", hypothesis[[i]]), pos = .GlobalEnv)
      

      mstrust(objfun = fit_obj, 
              
              center = fit_pars, 
              fixed = fit_fixed, 
              conditions = fit_conditions,
              
              studyname = fit_studyname, 
              sd = 4,
              blather = F, 
              cores = ncores, 
              fits = 20*ncores,
              iterlim = 200,
              
              parlower = c(
                Ka_co2c13    	=	-20	, # 1
                KBO_FIX_CO2  	=	-20	, # 2
                KBO_MAX_CO2  	=	-20	, # 3
                KBO_REL_CO2  	=	-20	, # 4
                KLI_MAX_CO2  	=	-20	, # 5
                KLU_EX_CO2   	=	-20	, # 6
                KLU_EXKM_CO2 	=	-20	, # 7
                Kp_co2c13    	=	-20	, # 8
                r_KLI_FIX_CO2	=	0	, # 9
                r_KLI_REL_CO2	=	0	  # 10 
              ), 
              parupper = c(
                Ka_co2c13    	=	20	, # 1
                KBO_FIX_CO2  	=	20	, # 2
                KBO_MAX_CO2  	=	20	, # 3
                KBO_REL_CO2  	=	20	, # 4
                KLI_MAX_CO2  	=	20	, # 5
                KLU_EX_CO2   	=	20	, # 6
                KLU_EXKM_CO2 	=	20	, # 7
                Kp_co2c13    	=	20	, # 8
                r_KLI_FIX_CO2	=	30	, # 9
                r_KLI_REL_CO2	=	30	  # 10 
              )
              ) 
      })
      ) %>%
    rowwise
    
     out

}, machine = c(paste0("knecht", c(1,2,4))), input = "model", filename = "2018_09_09_13_05_fit_short_roecker_job"
  , recover = T
)
# while(!fit_short_roecker_job$check())
#   Sys.sleep(10)
# beepr::beep(8)

# fit_short_roecker_job$check()
# fit_short_roecker <- fit_short_roecker_job$get()
# # fit_short_roecker %>% str1
# fit_short_roecker <- fit_short_roecker %>% uniteFits() %>% appendParframes
# saveRDS(fit_short_roecker, file = "fit_short_roecker.rds")
model <- readDMod.frame("fit_short_roecker.rds")
# fit_short_roecker_job$purge()

append_fixed <- function(myparf, fixed) {
  myattributes <- attributes(myparf)
  myattributes[["parameters"]] <- c(myattributes[["parameters"]], names(fixed))
  myattributes[["names"]] <- c(myattributes[["names"]], names(fixed))
  fixed <- unclass(fixed)
  myparf <- cbind(myparf,t(fixed))
  attributes(myparf) <- myattributes
  
  return(myparf)
}

model$parframes[[1]] <- append_fixed(model$parframes[[1]], model$fixed[[1]])
```

## explore fits
```{r}
model %>% parframes_summary()
model$parframes
```


```{r}
myparframe <- model$parframes[[1]]
```

```{r}
myparframe %>% plotPars(tol = 5, value < quantile(value, 0.1))
```

```{r}
parameters <- c(free_pars, "Ka_apap", "APAPD_HLM_CL", "APAPD_Km_apap")
p <- model$p[[1]]
condition = 1
p_parframe <- function(p,myparframe, parameters, condition) {
  old_attr <- attributes(myparframe)
  parframe_reduced <- as.data.frame(myparframe)
  parframe_reduced <- parframe_reduced[!names(parframe_reduced)%in%old_attr$metanames]
  newpars <- apply(parframe_reduced, 1, function(i) {
    pinner <- p(i, deriv = F, condition = condition)[[1]]
    pinner[parameters]
  }) %>% 
    t
  
  df <- as.data.frame(myparframe)
  new_parframe <- cbind(df[old_attr$metanames], newpars)
  
  new_attr <- old_attr
  new_attr[["parameters"]] <- parameters
  new_attr[["names"]] <- names(new_parframe)
  
  attributes(new_parframe) <- new_attr
  
  return(new_parframe)
}

reindex <- function(myparframe) {
  myparframe$index <- 1:nrow(myparframe)
  myparframe
}

p_log <- P(parameters %>% setNames(.,.) %>% insert("x~log(x)", x = .currentSymbols))

newparf <- p_parframe(model$p[[1]], myparframe, parameters, 1)
newparf <- p_parframe(p_log, newparf, parameters, 1)
```

```{r}
lq <- 0.0
uq <- 0.5
newparf %>% 
  as.data.frame() %>% 
  filter(value < quantile(value, uq), value>quantile(value, lq)) %>% 
  select(-c(1:4)) %>% 
  select(-(11:14)) %>% 
  pairs
```


```{r}
lq <- 0.0
uq <- 0.5
mylm <- newparf %>% 
  as.data.frame() %>% 
  filter(value < quantile(value, uq), value>quantile(value, lq)) %>% 
  lm(KLU_EX_CO2~KLU_EXKM_CO2,.)

mylm %>% summary
# myparframe %>% 
#   filter(value < quantile(value, 0.30)) %>%
#   ggplot(aes(x = r_KLI_FIX_CO2, r_KLI_REL_CO2, color = value)) + 
#   geom_point()


myparframe %>% 
  filter(value < quantile(value, uq), value>quantile(value, lq)) %>% 
  ggplot(aes(x = KLU_EXKM_CO2, KLU_EX_CO2, color = value)) + 
  geom_point() +
  geom_abline(slope = mylm$coefficients[2], intercept = mylm$coefficients[1])



```

```{r}
# p_KLU <- getParameters(model$p[[1]]) %>% setNames(.,.) %>% `[<-`("KLU_EX_CO2", "KLU_EX_CO2_int + KLU_EX_CO2_slope * KLU_EXKM_CO2") %>% P(modelname = "p_KLU", compile = T)
# KLU_mu = c(KLU_EX_CO2_int = 0.668, KLU_EX_CO2_slope = 0.919508)
# obj_KLU <- constraintL2(mu = KLU_mu, sigma = c(KLU_EX_CO2_int = 0.03, KLU_EX_CO2_slope = 0.005))
# ```
# 
# ```{r}
# model$p[[1]] <- (model$p[[1]] * p_KLU)
# model$p_sig[[1]] <- (model$p_sig[[1]] * p_KLU)
# model$obj_KLU <- list(obj_KLU)
# model$parframes[[1]] <- append_fixed(model$parframes[[1]], KLU_mu)
# 
# model <- model %>% 
#   rowwise() %>% 
#   appendObj() %>% 
#   mutate(prd_sig = list(g_sig * x_sig * p_sig), 
#          obj_data_sig = list(normL2(data_sig, prd_sig, e_sig)),
#          pars = list(union(getParameters(p), getParameters(p_sig)) %>% are_names_of(rnorm)),
#          obj = list(obj_data+ obj_data_sig + obj_KLU),
#          times = list(c(
#            seq(0,1,length.out = 500),
#            seq(min(rbind(as.data.frame(data),as.data.frame(data_sig))[["time"]]), 
#                           max(rbind(as.data.frame(data),as.data.frame(data_sig))[["time"]]) * 1.1, 
#                           length.out = 200)
#            ))
#          ) %>% 
#   mutate(prd_data = list(prd),
#          prd = list(prd_data+prd_sig), 
#          data_data = list(data),
#          data = list(data_data + data_sig),
#          description = "Model v49")
```


```{r}
plotPars(newparf[c(1,50,100,150,280,450)])+ 
  scale_color_dMod(labels= as.character(c(1,50,100,150,280,450)))
ggsave("parameters 1 50 100 150 280 450.pdf") 
```

## Fit Ka_metc13

```{r}
fit_short_roecker_job <- runbg({
    ncores <- detectFreeCores()
    assign("ncores", ncores, pos = .GlobalEnv)

   out <- model %>%
    ungroup %>%
    mutate(fits = map(seq_along(x), function(i) {
      assign("fit_obj", obj[[i]], pos = .GlobalEnv)
      
      fit_fixed <- fixed[[i]]
      assign("fit_fixed", fit_fixed, pos = .GlobalEnv)
      
      fit_pars <- pars[[i]] * 0 
      fit_pars <- fit_pars[!names(fit_pars)%in%names(fit_fixed)]
      assign("fit_pars", fit_pars, pos = .GlobalEnv)
      
      fit_conditions = c(cond_bic[[i]])
      assign("fit_conditions", fit_conditions, pos = .GlobalEnv)
      assign("fit_studyname", paste0("fits", hypothesis[[i]]), pos = .GlobalEnv)
      

      mstrust(objfun = fit_obj, 
              
              center = fit_pars, 
              fixed = fit_fixed, 
              conditions = fit_conditions,
              
              studyname = fit_studyname, 
              sd = 4,
              blather = F, 
              cores = ncores, 
              fits = 20*ncores,
              iterlim = 200,
              
              parlower = c(
                Ka_co2c13    	=	-20	, # 1
                KBO_FIX_CO2  	=	-20	, # 2
                KBO_MAX_CO2  	=	-20	, # 3
                KBO_REL_CO2  	=	-20	, # 4
                KLI_MAX_CO2  	=	-20	, # 5
                KLU_EX_CO2   	=	-20	, # 6
                KLU_EXKM_CO2 	=	-20	, # 7
                Kp_co2c13    	=	-20	, # 8
                r_KLI_FIX_CO2	=	0	, # 9
                r_KLI_REL_CO2	=	0	  # 10 
              ), 
              parupper = c(
                Ka_co2c13    	=	20	, # 1
                KBO_FIX_CO2  	=	20	, # 2
                KBO_MAX_CO2  	=	20	, # 3
                KBO_REL_CO2  	=	20	, # 4
                KLI_MAX_CO2  	=	20	, # 5
                KLU_EX_CO2   	=	20	, # 6
                KLU_EXKM_CO2 	=	20	, # 7
                Kp_co2c13    	=	20	, # 8
                r_KLI_FIX_CO2	=	30	, # 9
                r_KLI_REL_CO2	=	30	  # 10 
              )
              ) 
      })
      ) %>%
    rowwise
    
     out

}, machine = c(paste0("knecht", c(1,2,4))), input = "model", filename = "2018_09_09_13_05_fit_short_roecker_job"
  , recover = T
)
# while(!fit_short_roecker_job$check())
#   Sys.sleep(10)
# beepr::beep(8)

# fit_short_roecker_job$check()
# fit_short_roecker <- fit_short_roecker_job$get()
# # fit_short_roecker %>% str1
# fit_short_roecker <- fit_short_roecker %>% uniteFits() %>% appendParframes
# saveRDS(fit_short_roecker, file = "fit_short_roecker.rds")
model <- readDMod.frame("fit_short_roecker.rds")
# fit_short_roecker_job$purge()

append_fixed <- function(myparf, fixed) {
  myattributes <- attributes(myparf)
  myattributes[["parameters"]] <- c(myattributes[["parameters"]], names(fixed))
  myattributes[["names"]] <- c(myattributes[["names"]], names(fixed))
  fixed <- unclass(fixed)
  myparf <- cbind(myparf,t(fixed))
  attributes(myparf) <- myattributes
  
  return(myparf)
}

model$parframes[[1]] <- append_fixed(model$parframes[[1]], model$fixed[[1]])
```


# Plotting

```{r plotting helpers}
observables <- model$g[[1]] %>% getEquations() %>%.[[1]] %>%  names

observables_apap <- "Mve_apap"
observables_bic <- c("cum_rec_co2c13", "DOB","P_CO2F")
observables_met <- c("mom_rec_metc13", "cum_rec_metc13")

conditions <- model$obj[[1]] %>% getConditions()
data <- model$data[[1]] %>% as.data.frame()

cond_apap <- data %>% filter(name%in%"Mve_apap") %>% .[["condition"]] %>% unique %>% as.character()
cond_bic <- data %>% filter(name%in%c("cum_rec_co2c13", "DOB","P_CO2F")) %>% .[["condition"]] %>% unique %>% as.character()
cond_met <- data %>% filter(name%in%c("mom_rec_metc13", "cum_rec_metc13")) %>% .[["condition"]] %>% unique %>% as.character()


modelversion <- paste0(49, "Short Roecker")
which_hypotheses <- c(1)
step <- 280

```

### Write parameters
```{r}
# Write parameters to pars.csv
free_pars <- c("Kp_co2c13", "KBO_MAX_CO2", "KBO_REL_CO2", "KBO_FIX_CO2", "KLI_MAX_CO2", "KLI_REL_CO2", "KLI_FIX_CO2", "KLU_EX_CO2", "KLU_EXKM_CO2", "Ka_co2c13", "Ka_metc13")
hypothesis <- 1

walk(hypothesis, function(i) {
  pars <- model$parframes[[i]] %>% as.parvec(step)
  pinner <- model$p[[i]](pars)[[1]][free_pars]
  
  pinner <- c(unclass(pinner), 
    "APAPD_HLM_CL" = 2.20866840885261,
    "Ka_apap" = 2.47235563004252,
    "APAPD_Km_apap"= 0.347655392999114
  )
  tibble(parname = names(pinner), parvalue = pinner) %>% write_csv(paste0("pars",i, "_",modelversion, "_step_", step, ".csv"))
})

```


```{r plot waterfalls}
tol <- 10
pdf(paste0("waterfalls_",modelversion, "_tol_", tol, ".pdf"))

i <- 1
mysummary <- parframes_summary(model)
walk(which_hypotheses, function(i) {
  assign("i", i, .GlobalEnv) 
  cat(i, "\n")
  plotValues(model, i, value < mysummary[[i]]$values["1st Qu."], tol = tol) %>% print
  plotValues(model, i, value < mysummary[[i]]$values["Median"], tol = tol) %>% print
  plotValues(model, i, value < mysummary[[i]]$values["3rd Qu."], tol = tol) %>% print
  plotValues(model, i) %>% print
  plotPars(model, i, tol = tol, nsteps = 3) %>% print
  return(NULL)
})
dev.off()
```


```{r plot predictions}
# Group conditions by observables
pdf(file = paste0("plots_",modelversion,"_step_", step, ".pdf"), width = 16, height = 9)
walk(which_hypotheses, function(i) {
  plotCombined(model, i, step, condition %in% cond_bic & name %in% observables_bic)%>% print
})

walk(which_hypotheses, function(i) {
  plotCombined(model, i, step, condition %in% cond_met & name %in% observables_met)%>% print
})
dev.off()
```





```{r plot conditions individually}
# Plot conditions individually
pdf(file = paste0("plots_individual_",modelversion, "_step_", step, ".pdf"), width = 16, height = 9)

walk(which_hypotheses, function(i) {
  cat(i, "\n")
  map(cond_bic %>% str_subset("Irv|Bars|Roe"), function(cond) {
    cat(cond, "\n")
    myobs <- case_when(#cond%in%cond_apap ~ list(observables_apap),
                       cond%in%cond_bic  ~ list(observables_bic)#,
                       #cond%in%cond_met  ~ list(observables_met)
                       ) %>% unlist
    assign("cond", cond, pos = .GlobalEnv)
    assign("myobs", myobs, pos = .GlobalEnv)
    
    plotCombined(model, i, step, eval(parse(text = deparse(substitute(condition %in% cond & name %in% myobs))))) %>% print
  })
})
dev.off()
```















# 2do programming

* plotCombined.tbl_df: transform argument not passed correctly?
* insert_runbg distribute
* insert_runbg wait_for_runbg below check
* insert_runbg fixed
* insert_runbg parupper, parlower
* append_fixed_to_parframe.tbl_df





```{r plot Profiles}
pdf(paste0("profiles_",modelversion,".pdf"))

mysummary <- parframes_summary(model)
map(which_hypotheses, function(i) {
  profplot <- model$profiles[[i]] %>% 
    plotProfile() +
    coord_cartesian(ylim = c(-1,4))
  print(profplot)
  NULL
})
dev.off()
```

```{r plot Profile paths}
pdf(paste0("profile_paths_",modelversion,".pdf"))

mysummary <- parframes_summary(model)
map(which_hypotheses, function(wh) {
  myproflist <- model$profiles[[wh]]
  map(myproflist, function(prof_step) {
    which_pars <- prof_step[["whichPar"]] %>% unique() %>% str_subset_not("KBO_FIX_CO2")
    map(which_pars, function(wp) {
      myplot <- plotPaths(list(prof_step), whichPar = wp, relative = F) + ggtitle(paste0("x-axis: ", wp))
      print(myplot)
      NULL
    })
  })
  NULL
})
dev.off()
```






# clustering

```{r}
model$parframes[[1]] %>% 
  mutate(index = 1:length(index)) %>% 
  write_csv("all_fits.csv")
 
  
```

```{r}
clustering <- oldparframes[[1]] %>% 
  mutate(index = 1:length(index)) %>% 
  # filter(index < 170) %>% 
   select(-(1:4)) %>% 
  kmeans(30)


clustering
```


```{r}
model$parframes[[1]] %>% 
  mutate(index = 1:length(index)) %>% 
  filter(index < 170) %>% 
   select(-(1:4)) %>% 
  cor()
```

